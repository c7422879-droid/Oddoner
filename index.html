<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport optimizado para que no haga zoom automático y cubra todo el notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Metaetiquetas para iOS (iPhone/iPad) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Oddoner">

    <title>Oddoner</title>

    <link rel="manifest" href="manifest.json">
    <!-- Vercel UI Styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Iconos para PWA y Móviles (Asegúrate de tener estos archivos en la carpeta raíz) -->
    <link rel="apple-touch-icon" sizes="152x152" href="image/icon-152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="image/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="image/icon-512.png">
    <link rel="icon" type="image/png" sizes="512x512" href="image/icon-512.png">

    <meta name="theme-color" content="#131314">

    /* Fin de estilos de título */

    /* ESTILOS DE BOTÓN GENÉRICO PARA MODALES */
    .btn {
        background: var(--neon-blue);
        color: white;
        border: none;
        padding: 10px 20px;
        margin-top: 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s, box-shadow 0.3s;
        /* Asegurarse de que el botón de SMS sea un bloque */
        display: inline-block;
        text-decoration: none; /* Quitar subrayado del enlace */
        text-align: center;
        box-shadow: 0 0 5px rgba(255, 0, 255, 0.5);
        touch-action: manipulation; /* Optimización táctil */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    @media (hover: hover) {
        .btn:hover {
            background: var(--neon-purple);
            box-shadow: 0 0 15px var(--neon-purple);
        }
    }
    .btn svg { width: 20px; height: 20px; fill: currentColor; }
    .btn:disabled {
        background: #444;
        cursor: not-allowed;
        box-shadow: none;
    }
    .btn:active {
        transform: scale(0.96); /* Feedback táctil al presionar */
    }
      
    /* ####### ESTILOS DE INICIO ####### */
      
    /* ESTRELLAS DE FONDO */
    #stars-container {
        position: fixed; inset: 0; z-index: -1; pointer-events: none;
    }
    .star {
        position: absolute; background: white; border-radius: 50%;
        animation: twinkle var(--duration) ease-in-out infinite;
        opacity: var(--opacity);
        box-shadow: 0 0 4px rgba(255, 255, 255, 0.3);
    }
    @keyframes twinkle {
        0%, 100% { opacity: var(--opacity); transform: scale(1); }
        50% { opacity: 0.1; transform: scale(0.5); }
    }

    /* Fin de estilos de inicio */

    /* BOTÓN DE CRISIS (Mantener) */
    #btn-crisis {
        position: absolute; top: 15px; right: 15px;
        background: var(--color-alert);
        color: white;
        padding: 8px;
        border-radius: 50%;
        width: 40px; height: 40px;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 0 15px var(--color-alert);
        z-index: 5000;
        transition: transform 0.2s;
    }
    
    /* BOTÓN DE MÚSICA ESQUINA IZQUIERDA */
    #music-corner-container {
        position: absolute; top: 15px; left: 15px;
        z-index: 5000;
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer;
    }
    #btn-music-corner {
        background: var(--surface-card);
        border: 2px solid var(--color-primary);
        color: white;
        border-radius: 50%;
        width: 40px; height: 40px;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.5em;
        box-shadow: 0 0 15px var(--color-primary);
        transition: transform 0.3s;
    }
    /* Iconos SVG en botones circulares */
    #btn-crisis svg, #btn-settings-corner svg, #btn-music-corner svg {
        width: 24px; height: 24px; fill: white;
    }

    #btn-music-corner:hover { transform: scale(1.1); }
    #music-credits {
        font-size: 0.5em; 
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-top: 4px;
        font-weight: bold;
        text-shadow: 0 0 3px #000;
        line-height: 1.1;
    }

    /* BOTÓN DE INSTALAR APP (NUEVO - OPTIMIZADO) */
    #install-container {
        position: absolute; bottom: 15px; right: 15px;
        z-index: 5000;
        display: none; /* Se activa con JS */
    }
    #btn-install {
        background: var(--gemini-gradient);
        color: white; border: none; padding: 6px 10px; border-radius: 4px;
        font-size: 0.65em; font-weight: bold; cursor: pointer;
        box-shadow: 0 0 10px rgba(75, 144, 255, 0.4); text-transform: uppercase;
        text-align: center; line-height: 1.2;
    }

    /* BOTÓN DE AJUSTES ESQUINA IZQUIERDA INFERIOR */
    #settings-corner-container {
        position: absolute; bottom: 15px; left: 15px;
        z-index: 5000;
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer;
    }
    #btn-settings-corner {
        background: var(--surface-card);
        border: 2px solid var(--text-secondary);
        color: white;
        border-radius: 50%;
        width: 40px; height: 40px;
        display: flex; justify-content: center; align-items: center;
        font-size: 1.5em;
        box-shadow: 0 0 15px var(--text-secondary);
        transition: transform 0.3s;
    }
    #btn-settings-corner:hover { transform: scale(1.1); }
    #settings-credits { /* Reusing music-credits style */
        font-size: 0.5em; 
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        margin-top: 4px;
        font-weight: bold;
        text-shadow: 0 0 3px #000;
        line-height: 1.1;
    }

    /* CONTENIDO PRINCIPAL */
      
    #content-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }

    /* RELOJ ORBITAL */
    #clock-wrapper {
        position: relative; width: 100%; max-width: 320px;
        aspect-ratio: 1 / 1; margin: 0 auto; transform: scale(0.9);
    }
    
    /* CANVAS RELOJ MAGNÉTICO */
    #magnetic-clock-canvas {
        position: absolute; inset: 0; width: 100%; height: 100%;
        z-index: 1; pointer-events: none;
    }

    /* ===== RELOJ HUD FUTURISTA (ADICIONAL) ===== */
    #counter-content {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; font-weight: bold;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 18px;
        padding: 14px 18px;
        background: rgba(30, 31, 32, 0.85); /* Fondo semitransparente para leer sobre partículas */
        backdrop-filter: blur(4px);
        box-shadow: none; /* Sombra invisible */
        z-index: 10; /* Encima del canvas */
        cursor: pointer; /* Indicar que es clicleable */
        transition: background 0.3s;
    }
    @media (hover: hover) {
        #counter-content:hover {
            background: var(--surface-hover);
        }
    }
    #days-display {
        font-size: 1.6em;
        font-weight: 700;
        letter-spacing: 3px;
    }
    #hms-display {
        font-family: monospace;
        font-size: 0.9em;
        opacity: 0.65;
        letter-spacing: 2px;
    }
    #clock-footer { 
        text-align: center; 
        margin-top: 15px; 
        cursor: pointer;
        padding: 10px;
        border-radius: 12px;
        transition: background 0.3s;
    }
    @media (hover: hover) {
        #clock-footer:hover {
            background: var(--surface-hover);
        }
    }

    /* BARRA DE PROGRESO (OPTIMIZADA) */
    #milestone-container {
        width: 85%; max-width: 300px; margin: 5px auto 15px auto;
    }
    .progress-labels {
        display: flex; justify-content: space-between;
        font-size: 0.75em; color: rgba(255,255,255,0.7);
        margin-bottom: 4px; font-family: 'Orbitron', sans-serif;
    }
    .progress-track {
        width: 100%; height: 4px; background: rgba(255,255,255,0.1);
        border-radius: 2px; overflow: hidden;
    }
    #progress-fill {
        height: 100%; width: 100%;
        background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
        transform-origin: left; transform: scaleX(0);
        will-change: transform;
    }

    /* PANEL DE BOTONES */
    #button-panel {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Reducido para 3 botones */
        gap: 15px; 
        width: 100%; 
        padding-top: 30px;
        max-width: 600px; /* Ancho máximo para el panel */
    }
    .circular-button {
        /* ESTILO TARJETA GEMINI */
        background: var(--surface-card);
        border: none;
        display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start;
        cursor: pointer; 
        border-radius: 16px; /* Bordes redondeados de tarjeta */
        height: 150px; /* Altura fija para tarjetas más grandes */
        width: 100%;
        padding: 16px;
        box-sizing: border-box;
        transition: background 0.2s, transform 0.2s;
        box-shadow: none; /* Sin sombra (plano) */
        position: relative;
        overflow: hidden;
        will-change: transform;
        touch-action: manipulation;
    }
    @media (hover: hover) {
        .circular-button:hover {
            transform: translateY(-2px);
            background: var(--surface-hover);
            box-shadow: none;
        }
    }
    .circular-button:active {
        transform: scale(0.95);
    }
    /* ESTILOS PARA ICONOS SVG (IMÁGENES ESTÁTICAS) */
    .circular-button svg { 
        width: 40px; /* Icono más grande */
        height: 40px;
        fill: var(--text-secondary); /* Color base grisáceo */
        margin-bottom: auto;
        z-index: 2;
        transition: fill 0.3s, transform 0.3s;
    }
    @media (hover: hover) {
        .circular-button:hover svg {
            transform: scale(1.1);
            fill: var(--color-secondary); /* Se ilumina con el azul Gemini al pasar el mouse */
            filter: drop-shadow(0 0 8px rgba(75, 144, 255, 0.4));
        }
    }
    .circular-button .title { 
        font-size: 1.1em; /* Título más grande */
        font-family: 'Roboto', sans-serif; /* Fuente limpia */
        font-weight: 500; 
        margin-top: 4px; 
        color: var(--text-primary);
        text-transform: none; /* Texto normal, no mayúsculas */
        letter-spacing: 0;
        text-align: left;
        z-index: 2;
        text-shadow: none;
    }
    
    #date-picker-icon {
        display: inline-block;
        cursor: pointer;
        margin-bottom: 10px;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.2s, transform 0.2s;
    }
    #date-picker-icon svg {
        width: 28px; height: 28px;
        fill: var(--text-secondary);
        vertical-align: middle;
        transition: fill 0.2s;
        touch-action: manipulation;
    }
    @media (hover: hover) {
        #date-picker-icon:hover { transform: scale(1.1); background: var(--surface-hover); }
        #date-picker-icon:hover svg { fill: var(--neon-blue); }
    }

    /* Efecto de brillo que pasa por el botón */
    .circular-button::after {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: 0.5s;
        pointer-events: none;
    }
    @media (hover: hover) {
        .circular-button:hover::after {
            left: 100%;
        }
    }

    /* AJUSTE PARA PANTALLAS MUY PEQUEÑAS (Móviles angostos) */
    @media (max-width: 480px) {
        header h1 {
            font-size: 2.2em; /* Reducir el tamaño del título principal */
            letter-spacing: 2px;
        }
        .menu-btn-grid {
            grid-template-columns: 1fr !important; /* Una columna para los botones de menú */
        }
        .modal-content {
            padding: 15px; /* Reducir el padding en modales */
        }
        body {
            /* Ajuste seguro para móviles pequeños */
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            padding-left: max(10px, env(safe-area-inset-left));
            padding-right: max(10px, env(safe-area-inset-right));
        }
        /* Ajustar tamaño de botones de categoría principal en móvil */
        #button-panel {
             grid-template-columns: 1fr;
             max-width: 300px;
        }
        .circular-button {
             height: 120px;
        }
        /* Optimización táctil y visual para móviles */
        input, textarea, select {
            font-size: 16px !important; /* Evita zoom automático en iOS al escribir */
        }
        #btn-crisis, #btn-music-corner, #btn-settings-corner {
            width: 48px; height: 48px; /* Área táctil más grande y cómoda */
        }
        #clock-wrapper {
            transform: scale(0.85); /* Ajuste para evitar desbordes en pantallas angostas */
            margin-bottom: -15px;
        }
    }

    /* Estilos para The Loom of Forgiveness (Mochila V2) */
    #loom-overlay canvas { width: 100%; height: 100%; }
    #loom-overlay #ui {
        position: fixed; bottom: 10%; width: 100%; text-align: center;
        color: rgba(255,255,255,0.4); pointer-events: none;
        font-family: 'Courier New', monospace;
    }
    #loom-overlay #input-box {
        position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
        background: transparent; border: none; border-bottom: 1px solid #4facfe;
        color: white; text-align: center; font-size: 1.2rem; outline: none;
        letter-spacing: 2px; width: 80%;
    }
    #loom-overlay #core {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 60px; height: 60px; border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 40px rgba(79, 172, 254, 0.2);
        border: 1px solid rgba(255,255,255,0.1);
        pointer-events: none;
    }

    .card input { /* Mantener para compatibilidad si se usa en otro lado */
        width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;
        background: #131314; border-radius: 8px; box-sizing: border-box; color: white;
    }

    /* MODALES CONTENIDO */
    .modal-overlay {
        position: fixed; inset: 0; /* En móvil fixed es mejor, en PC el media query lo hace absolute */
        background: rgba(0,0,0, 0.8);
        display: flex; justify-content: center; align-items: center;
        z-index: 9500;
    }
    .modal-content {
        background: var(--surface-card); /* Fondo oscuro estilo Gemini */
        border: 1px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
        padding: 20px;
        border-radius: 20px;
        width: 95%;
        max-width: 550px;
        text-align: center;
        max-height: 95vh;
        overflow-y: auto;
        position: relative;
        color: var(--text-primary); /* Texto Claro */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        overscroll-behavior: contain; /* Evita que el scroll del modal mueva el fondo */
    }
    .modal-content h2, .modal-content h3, .modal-content h1, .modal-content h4, .modal-content p, .modal-content label, .modal-content span, .modal-content div {
        color: var(--text-primary) !important; /* Forzar texto claro en ventanas */
    }
    .hidden { display: none !important; }

    /* Estilos del Journal (Diario) con NEÓN */
    #journal-textarea {
        width: 100%;
        min-height: 150px; /* Reducido para dejar espacio al historial */
        padding: 15px;
        border-radius: 10px;
        /* Estilo Azul Neón */
        border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: none;
        background-color: var(--bg-app);
        color: var(--text-primary); 
        font-family: 'Roboto', sans-serif;
        font-size: 1em;
        line-height: 1.5;
        box-sizing: border-box;
        resize: vertical;
        transition: box-shadow 0.3s;
    }
    /* Estilo de enfoque (hover/focus) */
    #journal-textarea:focus {
        outline: none;
        border: 2px solid var(--neon-blue);
    }
    
    /* ESTILO PARA EL TEXTAREA DEL NIÑO INTERIOR */
    #inner-child-textarea {
        width: 100%;
        min-height: 100px; /* Más corto que el diario principal */
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: none;
        background-color: var(--bg-app);
        color: var(--text-primary); 
        font-family: 'Roboto', sans-serif;
        font-size: 1em;
        line-height: 1.4;
        box-sizing: border-box;
        resize: vertical;
        margin-top: 15px;
    }
    #inner-child-textarea:focus {
        outline: none;
        border: 2px solid var(--neon-blue);
    }

    /* --- ESTILOS DE HISTORIAL --- */
    .history-container {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        text-align: left;
    }
    .history-container h4 {
        color: var(--neon-blue) !important;
        font-size: 1em;
        margin-bottom: 10px;
        text-align: center;
    }
    .history-item {
        border-left: 3px solid var(--neon-blue);
        padding: 8px 10px 8px 15px;
        margin-bottom: 15px;
        background: var(--surface-hover);
        border-radius: 5px;
        font-size: 0.85em;
        color: var(--text-primary);
        white-space: pre-wrap; /* Mantener saltos de línea */
    }
    .history-item strong {
        display: block;
        color: var(--neon-blue) !important;
        margin-bottom: 3px;
        font-size: 0.9em;
    }
    /* --- FIN ESTILOS DE HISTORIAL --- */
      
    #journal-info {
        font-size: 0.75em;
        color: var(--text-secondary) !important;
        opacity: 0.7;
        margin-top: 10px;
        text-align: left;
    }


    /* ESTILOS ESPECÍFICOS DE MODAL ANIMATED (MOCHILA/NIÑO INTERIOR) */
    .concept-header {
        background: rgba(75, 144, 255, 0.1);
        border-left: 5px solid var(--neon-blue);
        padding: 10px 15px;
        margin-bottom: 20px;
        text-align: left;
        font-weight: bold;
        color: var(--text-primary);
        font-size: 0.95em;
    }
    .task-list {
        margin-top: 20px;
        text-align: left;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    .task-item-container {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    .task-circle {
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        margin-right: 15px;
        background-color: var(--neon-blue);
        box-shadow: none;
        border: none;
    }
    .task-text {
        color: var(--text-primary);
        font-size: 0.95em;
        line-height: 1.4;
        padding-top: 5px;
    }
    .task-text strong {
        color: var(--neon-blue) !important;
    }
    /* Fin de estilos de Mochila */

    /* ESTILOS DE LISTA PARA 12 PASOS (MEJORADO) */
    .aa-steps-list {
        text-align: left;
        list-style-type: none;
        counter-reset: step-counter;
        padding: 0;
        margin: 20px auto;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        gap: 12px; /* Espacio entre cada paso */
    }
    .aa-steps-list li {
        counter-increment: step-counter;
        display: flex;
        align-items: flex-start; /* Alinear al inicio para textos largos */
        gap: 12px;
        background: var(--surface-hover);
        padding: 12px;
        border-radius: 12px;
        border-left: 3px solid var(--neon-blue);
        font-size: 0.9em;
        color: var(--text-primary);
        line-height: 1.5;
    }
    .aa-steps-list li::before {
        content: counter(step-counter);
        flex-shrink: 0; /* Evitar que el círculo se encoja */
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--neon-blue);
        color: white;
        font-size: 0.9em;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        box-shadow: 0 0 8px rgba(75, 144, 255, 0.4);
    }

    /* --- MAPA DE PRÁCTICA DIARIA --- */
    #daily-practice-map {
        margin-top: 30px;
        padding: 15px 5px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    #daily-practice-map h3 {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 1.2em;
        text-align: center;
    }
    .map-item {
        position: relative;
        padding-left: 50px;
        margin-bottom: 25px;
        text-align: left;
    }
    .map-item:before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: -25px;
        width: 2px;
        background: rgba(75, 144, 255, 0.3);
    }
    .map-item:last-child:before {
        height: 50%;
        bottom: auto;
    }
    .map-icon {
        position: absolute;
        left: 0;
        top: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--neon-blue);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        z-index: 10;
        box-shadow: 0 0 10px var(--neon-blue);
        border: none;
    }
    .map-content {
        background: var(--surface-hover);
        padding: 10px;
        border-radius: 8px;
        box-shadow: none;
        border: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }
    .map-content strong {
        display: block;
        font-size: 1em;
        margin-bottom: 5px;
        color: var(--neon-blue) !important;
    }
    .map-content input[type="date"],
    .map-content input[type="text"] {
        width: 100%;
        padding: 5px;
        margin-top: 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: var(--bg-app);
        border-radius: 4px;
        box-sizing: border-box;
        color: var(--text-primary);
        font-family: inherit;
        transition: border 0.3s ease;
    }
    /* Fin de estilos del mapa */

    /* AA MODAL HEADER QUOTE */
    .aa-quote-header {
        background: rgba(75, 144, 255, 0.1);
        border-left: 5px solid var(--neon-blue);
        padding: 10px 15px;
        margin-bottom: 20px;
        text-align: left;
        font-style: italic;
        color: var(--text-primary);
        font-size: 0.9em;
    }

    /* Estilos para el nuevo formulario de AA */
    .aa-form-section {
        margin-bottom: 15px;
        text-align: left;
    }
    .aa-form-section label {
        font-weight: bold;
        display: block;
        margin-bottom: 8px;
        color: var(--text-primary) !important;
    }
    .aa-form-section select, .aa-form-section textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-primary);
        background: var(--bg-app);
        font-size: 1em;
        font-family: inherit;
        box-sizing: border-box;
    }
    .aa-form-section input[type="range"] {
        width: 100%;
        cursor: pointer;
        accent-color: var(--neon-blue);
    }
      
    /* ESTILOS ESPECÍFICOS DE CRISIS (Para input) */
    .crisis-config {
        margin: 20px auto 30px auto;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        max-width: 350px;
        text-align: left;
    }
    .crisis-config input {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        font-size: 1em;
        color: var(--text-primary);
        background: var(--bg-app);
        box-sizing: border-box;
    }

    /* ####### ESTILOS NIÑO INTERIOR (NUEVO) ####### */
    .ic-container {
        width: 100%;
        max-width: 400px;
        text-align: center;
        margin: 0 auto;
        color: var(--text-primary);
    }
    .ic-pantalla { transition: opacity 0.5s ease; }
    .ic-avatar { font-size: 80px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    
    .btn-inicio-ic {
        background: var(--neon-blue);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 30px;
        font-size: 1.1em;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(183, 0, 255, 0.4);
        margin-top: 20px;
        font-weight: bold;
    }
    .espejo-contenedor {
        position: relative;
        width: 180px; height: 180px;
        margin: 30px auto;
    }
    .circulo-abrazo {
        width: 100%; height: 100%;
        background: var(--color-secondary); /* Azul/Cyan para contraste */
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        animation: pulso 2s infinite;
        user-select: none; -webkit-tap-highlight-color: transparent;
    }
    @keyframes pulso {
        0% { transform: scale(1); box-shadow: 0 0 0 0px rgba(0, 212, 255, 0.4); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(0, 212, 255, 0); }
        100% { transform: scale(1); }
    }
    .progreso-abrazo {
        position: absolute; top: -10px; left: -10px;
        width: 200px; height: 200px;
        border: 5px solid var(--neon-blue);
        border-radius: 50%;
        clip-path: inset(100% 0 0 0); /* Se llenará de abajo hacia arriba */
        transition: clip-path 0.1s linear;
        pointer-events: none;
    }
    .afirmacion-texto {
        font-size: 1.1em; font-style: italic; min-height: 60px; margin-top: 20px; color: var(--text-primary); font-weight: bold;
    }

    /* ESTILOS MOCHILA ALQUIMIA (NUEVO) */
    .mochila-step { display: none; animation: fadeIn 0.5s; }
    .mochila-step.active { display: block; }
    .mochila-categories { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .category-btn {
        background: var(--surface-card); border: 1px solid rgba(255,255,255,0.1);
        padding: 15px; border-radius: 10px; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        transition: transform 0.2s, background 0.2s;
    }
    .category-btn:hover { transform: scale(1.05); background: var(--surface-hover); }
    .mochila-textarea {
        width: 100%; padding: 10px; border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app);
        color: var(--text-primary); margin-bottom: 15px; resize: vertical; font-family: inherit;
    }
    .gem-collection { max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 20px; }
    .gem-category { margin-bottom: 15px; }
    .gem-category h4 { border-bottom: 1px solid; padding-bottom: 5px; margin-bottom: 10px; margin-top: 0; }
    .gem-item { background: var(--surface-hover); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid; }
    .gem-item .wisdom { display: block; font-weight: bold; margin-bottom: 4px; color: var(--text-primary); }
    .gem-item .origin { display: block; font-size: 0.8em; opacity: 0.7; font-style: italic; color: var(--text-secondary); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ESTILOS ORGANIZADOR MEJORADO */
    .org-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: bold; margin-left: 5px; text-transform: uppercase; display: inline-block; }
    .badge-alta { background: rgba(255, 0, 0, 0.15); color: #d32f2f; border: 1px solid #d32f2f; }
    .badge-media { background: rgba(255, 165, 0, 0.15); color: #f57c00; border: 1px solid #f57c00; }
    .badge-baja { background: rgba(0, 128, 0, 0.15); color: #388e3c; border: 1px solid #388e3c; }
    
    .org-progress-bg { width: 100%; height: 8px; background: var(--bg-app); border-radius: 4px; margin: 5px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .org-progress-fill { height: 100%; background: var(--gemini-gradient); transition: width 0.3s; }
    
    .org-controls { display: flex; gap: 5px; align-items: center; margin-left: 10px; }
    .org-btn-mini { padding: 2px 8px; font-size: 0.8em; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; background: var(--bg-app); color: var(--text-primary); font-weight: bold; }
    .org-btn-mini:hover { background: var(--neon-blue); color: white; }

    /* Estilos para el nuevo Organizador */
    .organizer-section {
        background: var(--surface-hover);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 12px;
        text-align: left;
    }
    .organizer-section h2 {
        color: var(--neon-blue);
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 1px solid;
        padding-bottom: 5px;
    }
    .organizer-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .organizer-input-group input {
        flex-grow: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--text-primary);
        background: var(--bg-app);
        box-sizing: border-box;
    }
    .organizer-input-group button {
        background: var(--neon-blue);
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 8px;
        cursor: pointer;
    }
    .organizer-list {
        list-style: none;
        padding: 0;
    }
    .organizer-list li {
        padding: 12px;
        margin-bottom: 8px;
        background: var(--bg-app);
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 3px solid var(--neon-blue);
    }
    .organizer-list .completado {
        text-decoration: line-through;
        opacity: 0.5;
    }
    .organizer-list button {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        padding: 5px;
    }
    .meta-item > div { width: 100%; }
    .meta-item .barra {
        width: 100%;
        background: rgba(255,255,255,0.1);
        height: 8px;
        border-radius: 4px;
        margin: 8px 0;
    }
    .meta-item .progreso {
        height: 100%;
        background: var(--gemini-gradient);
        border-radius: 4px;
    }

    /* ESTILOS FICHAS AA */
    .aa-chip {
        width: 70px; height: 70px; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
        box-shadow: 0 5px 10px rgba(0,0,0,0.2), inset 0 0 10px rgba(255,255,255,0.4);
        display: flex; justify-content: center; align-items: center;
        margin: 10px auto;
        font-weight: bold; color: #5d4037; text-shadow: 0 1px 0 rgba(255,255,255,0.4);
        font-size: 1em; border: 3px solid rgba(255,255,255,0.3);
        position: relative;
    }
    .chip-silver { background: radial-gradient(circle at 30% 30%, #e0e0e0, #9e9e9e); color: #333; }
    .chip-red { background: radial-gradient(circle at 30% 30%, #ff5252, #b71c1c); color: white; text-shadow: 0 1px 2px black; }
    .chip-gold { background: radial-gradient(circle at 30% 30%, #ffd700, #f57f17); color: #3e2723; }
    .chip-green { background: radial-gradient(circle at 30% 30%, #69f0ae, #1b5e20); color: white; text-shadow: 0 1px 2px black; }
    .chip-blue { background: radial-gradient(circle at 30% 30%, #448aff, #0d47a1); color: white; text-shadow: 0 1px 2px black; }
    .chip-purple { background: radial-gradient(circle at 30% 30%, #e040fb, #4a148c); color: white; text-shadow: 0 1px 2px black; }
    .chip-bronze { background: radial-gradient(circle at 30% 30%, #cd7f32, #5d4037); color: white; text-shadow: 0 1px 2px black; }
    
    /* ANIMACIÓN RESPIRACIÓN / FOCO VISUAL */
    @keyframes breathe {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.6); opacity: 0.5; }
    }

    /* Estilos para Pupila Dimensional */
    #pupila-dimensional-overlay.hidden {
        display: none !important;
    }
    #pupila-dimensional-overlay {
        display: flex;
    }
    /* Contenedor del Iris con textura */
    #portal {
        position: relative;
        width: 250px;
        height: 250px;
        border-radius: 50%;
        background: radial-gradient(circle, #000 30%, #1a1a1a 40%, #00d2ff 60%, #3a7bd5 100%);
        box-shadow: 0 0 100px rgba(58, 123, 213, 0.4);
        cursor: pointer;
        transition: all 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* La Pupila Realista */
    #inner-pupil {
        width: 80px;
        height: 80px;
        background: #000;
        border-radius: 50%;
        z-index: 2;
        box-shadow: inset 0 0 20px rgba(255,255,255,0.2);
        transition: transform 0.1s ease-out, width 0.8s, height 0.8s;
    }
    /* Capa de la Cámara con máscara circular */
    #vision-stream {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        opacity: 0;
        transform: scale(0.5) scaleX(-1); /* Invertido para efecto espejo */
        transition: all 1.2s ease-in-out;
        object-fit: cover;
        filter: saturate(1.2) contrast(1.1) brightness(1.1);
    }
    /* Frase Flotante Estilo "Humo" */
    #inner-child-text {
        position: absolute;
        bottom: 20%;
        width: 100%;
        text-align: center;
        color: white;
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
        letter-spacing: 5px;
        text-transform: uppercase;
        opacity: 0;
        pointer-events: none;
        text-shadow: 0 0 15px rgba(255,255,255,0.8);
        z-index: 5;
    }
    /* Estado Expandido (La Magia) */
    #portal.expanded {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
    }
    #portal.expanded #vision-stream {
        opacity: 1;
        transform: scale(1.1) scaleX(-1); /* Invertido para efecto espejo */
        border-radius: 0;
    }
    #portal.expanded #inner-pupil {
        width: 0; height: 0; /* La pupila se abre para dejar ver */
    }

    /* NEBULOSA DE VOZ (NIÑO INTERIOR) */
    #nebula-overlay {
        position: fixed; inset: 0; background: #000; z-index: 11000; /* Media query lo ajusta en PC */
        display: none; flex-direction: column; align-items: center; justify-content: center;
    }
    #nebula-canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        filter: blur(5px) contrast(1.2);
    }
    #nebula-ui {
        position: absolute; top: 40%; width: 100%; text-align: center;
        color: #fff; pointer-events: none; z-index: 11010;
        text-shadow: 0 0 10px rgba(255,255,255,0.5);
        transition: opacity 0.5s;
    }
    #nebula-start-btn {
        position: absolute; bottom: 15%; z-index: 11020;
        padding: 15px 30px; border-radius: 30px; border: 1px solid #fff;
        background: transparent; color: #fff; cursor: pointer; font-size: 1.2em;
    }
    .overlay-close-btn {
        position: absolute; top: 20px; right: 20px; z-index: 11020;
        background: rgba(255,255,255,0.2); border: none; color: white;
        width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer;
    }

    /* ESTILOS BOTONES DE AJUSTES (Si no existían) */
    .settings-btn {
        display: flex; align-items: center; padding: 15px;
        background: var(--surface-card); border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px; margin-bottom: 10px; cursor: pointer;
        transition: background 0.2s;
        gap: 15px;
    }
    .settings-btn:hover { background: var(--surface-hover); }
    .settings-btn .icon-container { width: 40px; height: 40px; border-radius: 50%; background: rgba(75, 144, 255, 0.1); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid var(--neon-blue); }
    .settings-btn svg { width: 20px; height: 20px; fill: var(--neon-blue); }
    .settings-btn .text { display: flex; flex-direction: column; text-align: left; }
    .settings-btn .text strong { color: var(--text-primary); font-size: 1em; }
    .settings-btn .text span { color: var(--text-secondary); font-size: 0.8em; }

    /* ESTILOS MENU BTN (Si no existían) */
    .menu-btn {
        background: var(--surface-card); border: 1px solid rgba(255,255,255,0.1);
        padding: 15px; border-radius: 16px; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        transition: transform 0.2s, background 0.2s; height: 100px;
    }
    .menu-btn:hover { transform: translateY(-2px); background: var(--surface-hover); }
    .menu-btn .icon { display: flex; align-items: center; justify-content: center; }
    .menu-btn .icon svg { width: 40px; height: 40px; fill: var(--neon-blue); }
    .menu-btn .text { color: var(--text-primary); font-weight: 500; }

    /* JUEGO COGNITIVO (MEMORIA) */
    .memory-game {
        display: grid;
        gap: 10px;
        perspective: 1000px;
        margin-top: 20px;
    }
    .memory-card {
        aspect-ratio: 1/1;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.5s;
        cursor: pointer;
    }
    .memory-card.flip { transform: rotateY(180deg); }
    .memory-card .front-face, .memory-card .back-face {
        width: 100%; height: 100%; position: absolute; border-radius: 8px;
        display: flex; justify-content: center; align-items: center;
        font-size: 2em; backface-visibility: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .memory-card .front-face { background: var(--surface-card); border: 2px solid var(--neon-blue); transform: rotateY(180deg); }
    .memory-card .back-face { background: var(--surface-hover); border: 2px solid rgba(255,255,255,0.1); color: var(--neon-blue); font-size: 1.5em; }
    
    /* NIVELES JUEGO */
    .level-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px;
    }
    .level-btn {
        background: var(--surface-card); border: 1px solid rgba(255,255,255,0.1);
        aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center;
        border-radius: 12px; color: var(--text-primary); cursor: pointer;
        font-weight: bold; font-size: 1.2em; transition: transform 0.2s, background 0.2s;
    }
    .level-btn:hover { transform: scale(1.05); background: var(--surface-hover); }
    .level-btn.locked { opacity: 0.4; cursor: not-allowed; background: #000; border-color: transparent; }
    .level-btn.completed { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 5px rgba(75, 144, 255, 0.3); }
    /* FIN JUEGO COGNITIVO */

    /* ORB NIÑO INTERIOR */
    .orb-container { position: relative; width: 150px; height: 150px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
    .orb { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #fadadd 0%, #ffc0cb 100%); box-shadow: 0 0 20px #ffc0cb; transition: all 0.5s; }
    .orb.alert { background: radial-gradient(circle, #ff6961 0%, #ff8c8c 100%); box-shadow: 0 0 30px #ff6961; transform: scale(1.1); }
    .warning-text { opacity: 0; color: #ff6961; font-weight: bold; transition: opacity 0.5s; margin-top: 10px; font-size: 0.9em; }
    .warning-text.visible { opacity: 1; }
    /* FIN ORB */

    /* ESTILOS ANALIZADOR DE SUSTANCIAS */
    .toxic-container { display: flex; flex-direction: column; gap: 20px; }
    .sustancia-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
    }
    .sustancia-btn {
        background: var(--surface-hover);
        color: var(--text-primary);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .sustancia-btn:hover {
        background: var(--surface-card);
        transform: translateY(-2px);
    }
    .sustancia-btn.active {
        background: var(--neon-blue);
        color: white;
        border-color: var(--neon-blue);
        box-shadow: 0 0 10px var(--neon-blue);
    }
    .toxic-panel {
        background: var(--surface-hover); padding: 15px; border-radius: 12px;
        text-align: left; border-left: 4px solid var(--neon-blue);
        display: none; /* Oculto por defecto */ animation: fadeIn 0.5s;
    }
    .toxic-panel p { margin: 8px 0; font-size: 0.9em; }
    .toxic-panel strong { color: var(--text-primary); }
    .risk-label { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 8px; vertical-align: middle; }
    .risk-danger { background: #ff5252; box-shadow: 0 0 8px #ff5252; }
    .risk-warning { background: #ffab40; box-shadow: 0 0 8px #ffab40; }
    .risk-success { background: #69f0ae; box-shadow: 0 0 8px #69f0ae; }
    #simulador-visual { height: 100px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: white; text-shadow: 1px 1px 5px rgba(0,0,0,0.7); background: radial-gradient(circle, var(--neon-blue) 0%, var(--bg-app) 70%); transition: all 0.5s ease-in-out; border: 1px solid rgba(255,255,255,0.1); }
    .effect-blur { filter: blur(3px); }
    .effect-distort { filter: hue-rotate(90deg) saturate(2); }
    .effect-shake { animation: shake 0.4s infinite; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 50% { transform: translateX(4px); } 75% { transform: translateX(-4px); } }

    /* ESTILOS RESPIRACIÓN CÓSMICA */
    #breath-container {
        position: relative;
        width: 220px;
        height: 220px;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #breath-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: radial-gradient(circle, var(--neon-blue) 0%, rgba(75, 144, 255, 0.2) 70%, transparent 100%);
        box-shadow: 0 0 30px var(--neon-blue);
        opacity: 0.6;
        transform: scale(1);
        will-change: transform, opacity;
    }
    #breath-text {
        position: absolute;
        color: var(--text-primary);
        font-weight: bold;
        font-size: 1.2em;
        pointer-events: none;
        text-shadow: 0 0 10px rgba(0,0,0,0.8);
        z-index: 2;
    }

    @media (max-width: 480px) {
        header h1 {
            font-size: 2.2em; /* Reducir el tamaño del título principal */
            letter-spacing: 2px;
        }
        .menu-btn-grid {
            grid-template-columns: 1fr !important; /* Una columna para los botones de menú */
        }
        .modal-content {
            padding: 15px; /* Reducir el padding en modales */
        }
        body {
            /* Ajuste seguro para móviles pequeños manteniendo env */
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            padding-left: max(10px, env(safe-area-inset-left));
            padding-right: max(10px, env(safe-area-inset-right));
        }
        /* Ajustar tamaño de botones de categoría principal en móvil */
        #button-panel {
             grid-template-columns: 1fr;
             max-width: 300px;
        }
        .circular-button {
             height: 120px;
        }
    }
      
</style>

<!-- Importar librería de Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>
    <div id="stars-container"></div>

    <div id="btn-crisis"><svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>

    <div id="settings-corner-container">
        <div id="btn-settings-corner"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
        <div id="settings-credits">AJUSTES</div>
    </div>

    <div id="music-corner-container">
        <div id="btn-music-corner"><svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>
        <div id="music-credits">MANUEL SALMUN<br>CREDITOS</div>
    </div>

    <div id="install-container">
        <button id="btn-install">DESCARGAR<br>ANDROID / PC</button>
    </div>

    <header>
        <h1>Oddoner</h1>
        <p>DANIEL GOMEZ PERALTA <br> CREADOR</p>
    </header>

    <div style="text-align: center; margin-bottom: 35px;">
        <h2 style="margin: 0 0 8px 0; font-weight: 400; font-size: 1.8em; color: var(--text-primary);">Hola, Bienvenido</h2>
        <p style="margin: 0; font-size: 1.1em; color: var(--text-secondary);">¿Por dónde empezamos?</p>
    </div>

    <div id="content-wrapper">
        <div id="clock-wrapper">
            <canvas id="magnetic-clock-canvas"></canvas>
            <div id="counter-content" title="Haz clic para reiniciar el contador">
                <div id="days-display">0 DÍAS</div>
                <div id="hms-display">00:00:00</div>
            </div>
        </div>

        <div id="clock-footer" title="Haz clic para cambiar la fecha de inicio">
            <p style="font-size: 0.9em; color: var(--text-secondary); opacity: 0.8;">Toca para ajustar la fecha de inicio</p>
        </div>

        <div id="milestone-container">
            <div class="progress-labels">
                <span id="lbl-next-goal">Meta: Calculando...</span>
                <span id="lbl-percent">0%</span>
            </div>
            <div class="progress-track">
                <div id="progress-fill"></div>
            </div>
        </div>

        <div id="button-panel">
            <div id="btn-open-taller" class="circular-button">
                <svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9l-2-1.09V6l-3-1.5L12 3zm6.82 6L12 11.71 5.18 9 12 6.29 18.82 9zM17 11.95v3.54L12 18.29l-5-2.8v-3.54L12 14.82l5-2.87z"/></svg>
                <span class="title">Mi Trabajo Interior</span>
            </div>
            <div id="btn-open-aa" class="circular-button">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 7l-5.19 9h10.38L12 7z"/></svg>
                <span class="title">Alcohólicos Anónimos</span>
            </div>
            <div id="btn-open-toxic" class="circular-button">
                <svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.45l8.27 14.3H3.73L12 5.45zM11 10v4h2v-4h-2zm0 6v2h2v-2h-2z"/></svg>
                <span class="title">Analizador Sustancias</span>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; margin-bottom: 20px;">
             <a href="#" id="btn-open-donation" class="btn" style="background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 8px 20px; font-size: 0.9em;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor; margin-right: 8px;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                Apoyar el Proyecto
             </a>
        </div>
    </div>

    <!-- AUDIO PLAYER (Oculto) -->
    <audio id="bg-music" loop>
        <source src="audio/relax.mp3" type="audio/mpeg">
    </audio>

    <div id="general-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="gen-modal-title"></h2>
            <div id="gen-modal-body"></div>
            <button id="btn-close-modal" class="btn">CERRAR</button>
        </div>
    </div>

    <!-- NEBULOSA OVERLAY -->
    <div id="nebula-overlay">
        <canvas id="nebula-canvas"></canvas>
        <div id="nebula-ui">
            <h2>Susurra o sopla...</h2>
            <p>Libera lo que tu niño interior calla</p>
        </div>
        <button id="nebula-start-btn" onclick="startNebula()">Activar Voz 🎙️</button>
        <button id="nebula-close-btn" class="overlay-close-btn" onclick="stopNebula()">×</button>
    </div>

    <!-- PUPILA DIMENSIONAL OVERLAY (NUEVO) -->
    <div id="pupila-dimensional-overlay" class="hidden" style="position: fixed; inset: 0; background: #020202; z-index: 11000; display: flex; justify-content: center; align-items: center;">
        <div id="portal">
            <video id="vision-stream" autoplay playsinline></video>
            <div id="inner-pupil"></div>
            <div id="inner-child-text">Hola pequeño,<br>te estaba esperando</div>
        </div>
        <button class="overlay-close-btn" id="btn-close-pupila">×</button>
    </div>

    <!-- The Loom of Forgiveness Overlay (NUEVO) -->
    <div id="loom-overlay" class="hidden" style="position: fixed; inset: 0; background: #050508; z-index: 12000; display: none;">
        <div id="core"></div>
        <input type="text" id="input-box" placeholder="Escribe un resentimiento...">
        <div id="ui">
            <p id="instruction">Arrastra el nudo al centro y sopla para perdonar</p>
        </div>
        <canvas id="canvas"></canvas>
        <button class="overlay-close-btn" id="btn-close-loom">×</button>
    </div>



    <!-- NEURO GATE OVERLAY (TEST COGNITIVO) -->
    <div id="neuro-gate-overlay" class="hidden" style="position: fixed; inset: 0; background: #131314; z-index: 14000; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none;"> <!-- Style inline fixed se sobrescribe por CSS class si es necesario -->
        <div id="neuro-ui-top" style="position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none;">
            <h3 style="color: var(--neon-blue); margin: 0; letter-spacing: 2px;">NEURO-GATE</h3>
            <p id="neuro-instruction" style="color: white; font-size: 1.1em; font-weight: bold; margin-top: 10px;">PREPARANDO...</p>
            <div style="font-size: 0.8em; color: #888; margin-top: 5px;">Ronda: <span id="neuro-round">0</span>/20</div>
        </div>
        
        <!-- Área de estímulo -->
        <div id="neuro-stimulus" style="width: 180px; height: 180px; border-radius: 50%; transition: transform 0.1s; cursor: pointer; display: none; box-shadow: 0 0 30px rgba(0,0,0,0.5);"></div>
        
        <div id="neuro-feedback-msg" style="position: absolute; bottom: 20%; color: #ff5252; font-weight: bold; opacity: 0; transition: opacity 0.2s; font-size: 1.5em;">¡FALLO!</div>
        
        <!-- Pantalla de Inicio -->
        <div id="neuro-start-screen" style="text-align: center; padding: 20px; max-width: 400px;">
            <div style="font-size: 3em; margin-bottom: 10px;">🚦</div>
            <h2 style="color: var(--text-primary);">Control de Inhibición</h2>
            <p style="color: var(--text-secondary); line-height: 1.6;">
                Este test mide tu capacidad para <strong>frenar impulsos</strong> (crucial para manejar la ansiedad).<br><br>
                1. Toca RÁPIDO si ves el color <strong>SEGURO</strong>.<br>
                2. NO TOQUES si ves el color de <strong>ALERTA</strong>.<br><br>
                ⚠️ <strong>Atención:</strong> Las reglas cambiarán a mitad del juego.
            </p>
            <button id="btn-start-neuro" class="btn" style="width: 100%; margin-top: 20px;">COMENZAR TEST</button>
            <button id="btn-close-neuro-start" class="btn" style="background: transparent; border: 1px solid #555; margin-top: 10px; width: 100%;">SALIR</button>
        </div>

        <!-- Pantalla de Resultados -->
        <div id="neuro-results" style="display: none; text-align: center; padding: 25px; background: var(--surface-card); border-radius: 20px; border: 1px solid var(--neon-blue); max-width: 320px; width: 90%;">
            <h3 style="color: white; margin-top: 0;">Diagnóstico Lógico</h3>
            <div style="margin: 20px 0; text-align: left; font-size: 0.95em;">
                <p style="margin-bottom: 10px;">⚡ Velocidad Mental: <strong id="res-time" style="color: var(--neon-blue); float: right;">0ms</strong></p>
                <p style="margin-bottom: 10px;">🏆 Mejor Récord: <strong id="res-best" style="color: #ffd700; float: right;">-</strong></p>
                <p style="margin-bottom: 10px;">🛑 Impulsividad (Errores): <strong id="res-impulse" style="color: #ff5252; float: right;">0</strong></p>
                <p style="margin-bottom: 10px;">💤 Atención (Omitidos): <strong id="res-miss" style="color: #ff9800; float: right;">0</strong></p>
            </div>
            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
            <p id="res-analysis" style="font-style: italic; color: #ccc; font-size: 0.9em; line-height: 1.4; margin-bottom: 20px;"></p>
            <button id="btn-close-neuro-results" class="btn" style="width: 100%;">CERRAR</button>
        </div>
    </div>

    <!-- Formulario oculto para detección de Netlify -->
    <form name="contact" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="name" />
        <input type="email" name="email" />
        <textarea name="message"></textarea>
    </form>

<!-- Vercel UI Interactivity -->
<script src="script.js" defer></script>

<script>
    const KEY = 'sobriety_date_full_v1';
    // Claves de registro múltiple
    const JOURNAL_KEY = 'daily_journal_history_v2'; 
    const INNER_CHILD_KEY = 'inner_child_history_v2'; 
    const EMERGENCY_CONTACT_KEY = 'emergency_contact_number_v1';
    
    const MORAL_INVENTORY_KEY = 'moral_inventory_v1';
    const TIME_CAPSULE_KEY = 'time_capsule_v1';
    const BRAIN_DUMP_KEY = 'brain_dump_v1';

    // --- CONFIGURACIÓN DE SUPABASE ---
    const supabaseUrl = 'https://hydmhaovulntaailfpjv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5ZG1oYW92dWxudGFhaWxmcGp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDQzMTEsImV4cCI6MjA4MjE4MDMxMX0.26S6m9rD7g8AVZ-tZvU6mWjBtdrv-5qKmHpxnlXQTl4';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // --- CONFIGURACIÓN MOCHILA ALQUIMIA ---
    const MOCHILA_KEY = 'mochila_gems_v1';
    const ALCHEMY_GUIDE = {
        'miedo': { title: 'Miedo', question: '¿Qué verdad se esconde detrás de este miedo?', placeholder: 'Ej: Que soy capaz de afrontarlo...', gem_type: 'Coraje', gem_color: '#ff9800' },
        'culpa': { title: 'Culpa', question: '¿Qué lección has aprendido de esto?', placeholder: 'Ej: Que ahora sé actuar diferente...', gem_type: 'Perdón', gem_color: '#4caf50' },
        'rencor': { title: 'Rencor', question: '¿Qué necesitas soltar para ser libre?', placeholder: 'Ej: La necesidad de tener razón...', gem_type: 'Compasión', gem_color: '#e91e63' },
        'tristeza': { title: 'Tristeza', question: '¿Qué te está enseñando esta pérdida o dolor?', placeholder: 'Ej: A valorar lo que tengo...', gem_type: 'Sabiduría', gem_color: '#2196f3' }
    };

    function guardarDia() {
        const registro = {
            fecha: new Date().toISOString().split('T')[0],
            decision: document.getElementById('decision').value,
            calma: document.getElementById('calma').value,
            honestidad: document.getElementById('honestidad').value,
            conexion: document.getElementById('conexion').value,
            microacto: document.getElementById('microacto').value,
            pensamiento: document.getElementById('pensamiento').value
        };

        let historial = JSON.parse(localStorage.getItem('aa_registros')) || [];
        historial.push(registro);
        localStorage.setItem('aa_registros', JSON.stringify(historial));

        alert("Día guardado correctamente 🙏");
        closeGenModal(); // Cerrar el modal después de guardar
    }
    
    // --- CLAVES DE NOTIFICACIÓN Y DONACIÓN ---
    const NOTIFICATION_KEY = 'daily_reminder_time_v1';
    const NOTIFICATION_MESSAGE_KEY = 'daily_reminder_msg_v1';
    
    // --- VARIABLES GLOBALES PARA DETECTOR MENTAL ---
    let currentMochilaCategory = '';
    let sessionClickCount = 0;
    let sessionScrollAmount = 0;
    let lastScrollY = window.scrollY;
    const sessionStartTime = Date.now();
    document.addEventListener('click', () => { sessionClickCount++; });
    // Listener de scroll optimizado para móvil
    document.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        // Acumular la distancia de scroll (en valor absoluto)
        sessionScrollAmount += Math.abs(currentScrollY - lastScrollY);
        lastScrollY = currentScrollY;
    }, { passive: true }); // {passive: true} para no bloquear el renderizado

    // ¡¡¡IMPORTANTE!!! REEMPLAZA ESTO CON TU ENLACE REAL DE PAGO (PAYPAL,Mercado Pago, etc.)
    const PAYPAL_LINK = 'https://link.mercadopago.com.mx/oddonerapp';

    let startTime = localStorage.getItem(KEY) ? parseInt(localStorage.getItem(KEY)) : new Date().getTime();
    if(!localStorage.getItem(KEY)) localStorage.setItem(KEY, startTime);

    const frases = ["Un día a la vez.", "Esto también pasará.", "Progreso, no perfección.", "Solo por hoy.", "La fe mueve montañas."];
      
    // --- FUNCIÓN DE CONTACTO DE EMERGENCIA ---
    function getEmergencyContact() {
        return localStorage.getItem(EMERGENCY_CONTACT_KEY) || '+5215512345678';
    }

    function saveEmergencyContact() {
        const input = document.getElementById('emergency-contact-input');

      if (input && input.value.trim()) {
            localStorage.setItem(EMERGENCY_CONTACT_KEY, input.value.trim());
            alert('Número de contacto seguro guardado.');
        } else {
            alert('Por favor, introduce un número válido.');
        }
    }
    

    // --- FUNCIONES DE GESTIÓN DE REGISTRO / HISTORIAL ---

    function loadJournalHistory(key) {
        const savedData = localStorage.getItem(key);
        if (!savedData) return [];
        return savedData.split('\n').filter(line => line.trim() !== '');
    }

    function generateHistoryHtml(historyLines, storageKey) {
        if (historyLines.length === 0) {
            return `<p style="font-size: 0.9em; opacity: 0.7; color: var(--text-secondary); text-align: center;">Aún no hay registros en el historial.</p>`;
        }
        
        const reversedHistory = historyLines.slice().reverse(); 
        
        let html = '';
        reversedHistory.forEach((line, index) => {
            const originalIndex = historyLines.length - 1 - index;
            const parts = line.split('] - ');
            let date = "Fecha desconocida";
            let content = line;

            if (parts.length > 1) {
                date = parts[0].replace('[', ''); 
                content = parts.slice(1).join('] - ');
            }
            
            // Sanitizar el contenido para prevenir inyección de HTML (XSS)
            const safeContent = content.replace(/&/g, "&amp;")
                                       .replace(/</g, "&lt;")
                                       .replace(/>/g, "&gt;")
                                       .replace(/"/g, "&quot;")
                                       .replace(/'/g, "&#039;");
            
            html += `<div class="history-item">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <strong>${date}</strong>
                            <button onclick="deleteJournalEntry(${originalIndex}, '${storageKey}')" style="background:none; border:none; cursor:pointer; font-size:1em; opacity:0.7; color: var(--color-alert);">❌</button>
                        </div>
                        <div style="margin-top:4px;">${safeContent}</div>
                     </div>`;
        });
        
        return html;
    }

    async function saveNewEntry(key, textareaId, modalTitle) {
        const textarea = document.getElementById(textareaId);
        if (!textarea || !textarea.value.trim()) {
            alert("No puedes guardar un registro vacío.");
            return;
        }

        const currentEntry = textarea.value.trim();
        const now = new Date().toLocaleDateString('es-ES', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const newEntryLine = `[${now}] - ${currentEntry}`;
        
        // 1. Guardar en LocalStorage (Copia local)
        let history = loadJournalHistory(key);
        history.push(newEntryLine);
        localStorage.setItem(key, history.join('\n'));
        
        // 2. Guardar en Supabase (Si hay usuario logueado)
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            const { error } = await supabaseClient
                .from('diario')
                .insert([
                    { 
                        user_id: user.id, 
                        contenido: currentEntry, 
                        tipo: key, // Identifica si es Diario o Niño Interior
                        fecha: new Date().toISOString()
                    }
                ]);
            if (error) console.error('Error guardando en nube:', error);
        }

        textarea.value = '';
        localStorage.removeItem(`TEMP_${key}`);
        
        alert(`Registro guardado en el historial de ${modalTitle}.`);
        
        if (key === JOURNAL_KEY) {
            // Recargar el modal para mostrar el historial actualizado
            openJournalModal();
        } else if (key === INNER_CHILD_KEY) {
            // Recargar el modal de Niño Interior para mostrar el historial actualizado
            openAnimatedModal(
                'Sanando al Niño Interior',
                [
                    {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>', text: '<strong>Visualiza</strong> a tu yo de 5 años. Nota sus heridas y necesidades.'},
                    {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>', text: '<strong>Pregúntale:</strong> *“¿Qué necesitas de mí hoy?”* Dale un abrazo virtual.'},
                    {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>', text: '<strong>Prométele</strong> que le darás seguridad, límites o afecto que le faltó.'}
                ],
                'Tu parte emocional con las heridas y las necesidades no cubiertas de la infancia.',
                '🧸'
            );
        }

    }

    function deleteJournalEntry(index, key) {
        if(!confirm("¿Eliminar esta entrada permanentemente?")) return;
        let history = loadJournalHistory(key);
        history.splice(index, 1);
        localStorage.setItem(key, history.join('\n'));
        
        if (key === JOURNAL_KEY) openJournalModal();
        else if (key === INNER_CHILD_KEY) openInnerChildModal();
    }

    function exportJournal() {
        const history = loadJournalHistory(JOURNAL_KEY);
        if (history.length === 0) return alert("El diario está vacío.");
        
        const text = history.join('\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mi_diario_oddoner.txt';
        a.click();
    }

    function saveTempEntry(key, textareaId) {
        const textarea = document.getElementById(textareaId);
        if (textarea) {
            localStorage.setItem(`TEMP_${key}`, textarea.value);
        }
    }
    
    function loadTempEntry(key) {
         return localStorage.getItem(`TEMP_${key}`) || '';
    }
    
    function openJournalModal() {
        const tempEntry = loadTempEntry(JOURNAL_KEY);
        const historyLines = loadJournalHistory(JOURNAL_KEY);
        const historyHtml = generateHistoryHtml(historyLines, JOURNAL_KEY);
        
        const today = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const content = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; fill: var(--neon-blue);"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                <h3 style="color: var(--neon-blue); margin: 0;">Inventario Diario (Paso 10)</h3>
            </div>
            <p style="font-size: 0.9em; color: var(--text-primary); margin-bottom: 20px; font-weight: bold;">
                ENTRADA ACTUAL: ${today.toUpperCase()}
            </p>
            
            <textarea id="journal-textarea" 
                      placeholder="Escribe tu inventario o tus pensamientos del día. Recuerda: ¿Qué hice mal? ¿Qué hice bien? ¿Qué me hizo enojar o tener miedo?..."
                      oninput="saveTempEntry(JOURNAL_KEY, 'journal-textarea')">${tempEntry}</textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="background: var(--neon-blue); flex:1;"
                        onclick="saveNewEntry(JOURNAL_KEY, 'journal-textarea', 'Diario')">
                    💾 GUARDAR
                </button>
                <button class="btn" style="background: var(--surface-hover); border:1px solid rgba(255,255,255,0.2); flex:1;"
                        onclick="exportJournal()">
                    📤 EXPORTAR
                </button>
            </div>
            
            <div id="journal-info">
                📝 La entrada actual se guarda automáticamente como borrador. Usa **Guardar Nuevo Registro** para moverla al historial y empezar una nueva.
            </div>

            <div class="history-container">
                <h4>Historial de Registros (${historyLines.length})</h4>
                ${historyHtml}
            </div>
        `;
        openModal("📓 Mi Diario", content);
    }
    
    // --- CÁPSULA DEL TIEMPO ---
    function openTimeCapsuleModal() {
        const capsules = JSON.parse(localStorage.getItem(TIME_CAPSULE_KEY) || '[]');
        const now = new Date();
        // Resetear horas de hoy para comparar fechas puras
        now.setHours(0,0,0,0);
        
        // Calcular fecha mínima para el input (mañana)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const minDate = tomorrow.toISOString().split('T')[0];

        let capsulesHtml = '';
        
        if (capsules.length === 0) {
            capsulesHtml = '<p style="opacity:0.7; font-style:italic; color: var(--text-secondary); padding: 20px;">No hay mensajes guardados para el futuro.</p>';
        } else {
            // Ordenar: primero las desbloqueadas, luego por fecha
            capsules.sort((a, b) => new Date(a.unlockDate) - new Date(b.unlockDate));

            capsules.forEach((cap, index) => {
                const parts = cap.unlockDate.split('-');
                const unlockDateObj = new Date(parts[0], parts[1]-1, parts[2]);
                const isUnlocked = now.getTime() >= unlockDateObj.getTime();
                
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                const dateStr = unlockDateObj.toLocaleDateString('es-ES', dateOptions);

                if (isUnlocked) {
                    capsulesHtml += `
                        <div style="background: var(--surface-hover); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--neon-blue); text-align: left; position: relative; animation: fadeIn 0.5s;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <strong style="color:var(--neon-blue); font-size: 0.9em;">🔓 ABIERTA (${dateStr})</strong>
                                <button onclick="deleteTimeCapsule(${index})" style="background:none; border:none; cursor:pointer; font-size: 1.2em;">❌</button>
                            </div>
                            <p style="margin:0; white-space: pre-wrap; color: var(--text-primary); font-size: 1em; line-height: 1.5;">${cap.message}</p>
                        </div>`;
                } else {
                    // Calcular días restantes
                    const diffTime = unlockDateObj.getTime() - now.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    
                    capsulesHtml += `
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed rgba(255,255,255,0.2); text-align: left; opacity: 0.8;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="color: var(--text-secondary); font-size: 0.9em;">🔒 BLOQUEADA</strong>
                                <button onclick="deleteTimeCapsule(${index})" style="background:none; border:none; cursor:pointer; opacity: 0.5;">❌</button>
                            </div>
                            <p style="margin:10px 0 5px 0; font-size:1.1em; font-weight: bold; color: var(--text-primary);">Faltan ${diffDays} días</p>
                            <p style="margin:0; font-size:0.8em; color: var(--text-secondary);">Disponible el: ${dateStr}</p>
                        </div>`;
                }
            });
        }

        const content = `
            <div style="text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5em;">⏳</span>
                    <h3 style="color: var(--neon-blue); margin: 0;">Cápsula del Tiempo</h3>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
                    Envía un mensaje de esperanza o recordatorio a tu "Yo del Futuro".
                </p>
                
                <div style="background: var(--surface-card); padding: 15px; border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1);">
                    <textarea id="capsule-message" placeholder="Querido yo del futuro, espero que hoy..." style="width: 100%; height: 100px; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary); margin-bottom: 15px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                    
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label style="font-size:0.9em; color: var(--text-secondary); white-space: nowrap;">Abrir el:</label>
                        <input type="date" id="capsule-date" min="${minDate}" style="flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary); font-family: inherit;">
                    </div>
                    
                    <button class="btn" onclick="saveTimeCapsule()" style="width: 100%;">🔒 SELLAR MENSAJE</button>
                </div>

                <h4 style="text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom: 15px; color: var(--text-primary);">Mis Cápsulas</h4>
                <div id="capsules-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                    ${capsulesHtml}
                </div>
                
                <button class="btn" style="background: transparent; border: 1px solid rgba(255,255,255,0.2); margin-top: 15px; font-size: 0.9em;" onclick="openJournalModal()">🔙 Volver al Diario</button>
            </div>
        `;
        openModal("⏳ Cápsula del Tiempo", content);
    }

    function saveTimeCapsule() {
        const message = document.getElementById('capsule-message').value.trim();
        const dateVal = document.getElementById('capsule-date').value;

        if (!message) return alert("Por favor escribe un mensaje.");
        if (!dateVal) return alert("Por favor selecciona una fecha.");

        const capsules = JSON.parse(localStorage.getItem(TIME_CAPSULE_KEY) || '[]');
        capsules.push({
            message: message,
            unlockDate: dateVal,
            createdAt: new Date().toISOString()
        });
        
        localStorage.setItem(TIME_CAPSULE_KEY, JSON.stringify(capsules));
        alert("✨ Cápsula sellada. Nos vemos en el futuro.");
        openTimeCapsuleModal();
    }

    function deleteTimeCapsule(index) {
        if(!confirm("¿Eliminar esta cápsula para siempre?")) return;
        const capsules = JSON.parse(localStorage.getItem(TIME_CAPSULE_KEY) || '[]');
        capsules.splice(index, 1);
        localStorage.setItem(TIME_CAPSULE_KEY, JSON.stringify(capsules));
        openTimeCapsuleModal();
    }

    // --- RELOJ Y ENTRADA ---
    // Optimización: Caché de elementos DOM
    const elDays = document.getElementById('days-display');
    const elHms = document.getElementById('hms-display');
    // Elementos de la barra de progreso
    const elProgressFill = document.getElementById('progress-fill');
    const elLblNext = document.getElementById('lbl-next-goal');
    const elLblPct = document.getElementById('lbl-percent');
    const MILESTONES = [1, 3, 7, 14, 30, 60, 90, 180, 270, 365, 730, 1095];

    // --- RELOJ ORBITAL ANALÓGICO ---
    let orbitalCtx;
    let orbitalCanvas;

    function initOrbitalClock() {
        orbitalCanvas = document.getElementById('magnetic-clock-canvas');
        if (orbitalCanvas) {
            orbitalCtx = orbitalCanvas.getContext('2d');
            resizeOrbitalClock();
            window.addEventListener('resize', resizeOrbitalClock);
        }
    }

    function resizeOrbitalClock() {
        if(orbitalCanvas) {
            const parent = orbitalCanvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            const rect = parent.getBoundingClientRect();
            
            orbitalCanvas.width = rect.width * dpr;
            orbitalCanvas.height = rect.height * dpr;
            
            if(orbitalCtx) orbitalCtx.scale(dpr, dpr);
            
            orbitalCanvas.style.width = `${rect.width}px`;
            orbitalCanvas.style.height = `${rect.height}px`;
        }
    }

    function drawOrbitalClock() {
        if (!orbitalCtx || !orbitalCanvas) return;
        
        const width = orbitalCanvas.width / (window.devicePixelRatio || 1);
        const height = orbitalCanvas.height / (window.devicePixelRatio || 1);
        const ctx = orbitalCtx;
        const centerX = width / 2;
        const centerY = height / 2;
        const now = new Date();
        
        ctx.clearRect(0, 0, width, height);
        
        const maxRadius = Math.min(width, height) / 2 - 5;
        const spacing = 18; 
        
        // Segundos (Exterior)
        const sec = now.getSeconds() + now.getMilliseconds() / 1000;
        const secAngle = (Math.PI * 2) * (sec / 60) - Math.PI / 2;
        drawOrbitRing(ctx, centerX, centerY, maxRadius, secAngle, '#4b90ff', 3);

        // Minutos (Medio)
        const min = now.getMinutes() + sec / 60;
        const minAngle = (Math.PI * 2) * (min / 60) - Math.PI / 2;
        drawOrbitRing(ctx, centerX, centerY, maxRadius - spacing, minAngle, '#ff5546', 4);

        // Horas (Interior)
        const hr = (now.getHours() % 12) + min / 60;
        const hrAngle = (Math.PI * 2) * (hr / 12) - Math.PI / 2;
        drawOrbitRing(ctx, centerX, centerY, maxRadius - spacing * 2, hrAngle, '#ffffff', 5);
    }

    function drawOrbitRing(ctx, x, y, radius, angle, color, size) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(x, y, radius, -Math.PI / 2, angle);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.globalAlpha = 0.6;
        ctx.stroke();
        ctx.globalAlpha = 1.0;

        const px = x + Math.cos(angle) * radius;
        const py = y + Math.sin(angle) * radius;

        ctx.beginPath();
        ctx.arc(px, py, size, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = color;
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    let minuteCounter = -1; 
    let lastAlertMinute = -1; 
    let lastRenderedSecond = -1;

    function updateClock() {
        drawOrbitalClock(); // Dibujar reloj orbital suavemente

        const now = new Date();
        const currentSecond = now.getSeconds();

        // OPTIMIZACIÓN: Solo actualizar el DOM si cambió el segundo
        if (currentSecond === lastRenderedSecond) {
            requestAnimationFrame(updateClock);
            return;
        }
        lastRenderedSecond = currentSecond;

        const currentTime = now.getTime();
        const diff = currentTime - startTime;
        const d = Math.floor(diff / 86400000);
        
        // Se corrige usando las propiedades estándar de Date.
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        if(elDays) elDays.innerText = d + ' DÍAS';
        if(elHms) elHms.innerText =
            (h<10?'0':'')+h + ":" + (m<10?'0':'')+m + ":" + (s<10?'0':'')+s;

        // --- LÓGICA BARRA DE PROGRESO ---
        // 1. Calcular días totales con fracción (para suavidad)
        const totalDays = d + (h / 24) + (m / 1440);
        // 2. Encontrar siguiente meta
        let next = MILESTONES.find(m => m > d);
        if (!next) next = Math.ceil((d + 1) / 365) * 365; // Si supera las metas fijas, ir al siguiente año
        // 3. Calcular porcentaje (0 a 1)
        const pct = Math.max(0, Math.min(1, totalDays / next));
        
        if (elProgressFill) elProgressFill.style.transform = `scaleX(${pct})`;
        if (elLblNext) elLblNext.innerText = `META: ${next} DÍAS`;
        if (elLblPct) elLblPct.innerText = `${(pct * 100).toFixed(1)}%`;

        // --- LÓGICA DE NOTIFICACIONES ---
        // Ejecutamos la verificación solo al comienzo de un nuevo minuto
        if (currentSecond === 0 && minuteCounter !== currentMinute) {
            checkNotifications();
            minuteCounter = currentMinute;
        }
        // --- FIN LÓGICA DE NOTIFICACIONES ---
          
        requestAnimationFrame(updateClock);
    }

    function initStars() {
        const container = document.getElementById('stars-container');
        if (!container) return;
        const count = 60; // Cantidad de estrellas
        for (let i = 0; i < count; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            const size = Math.random() * 2 + 1; // Tamaño entre 1 y 3px
            const duration = Math.random() * 3 + 2; // Duración entre 2 y 5s
            
            star.style.left = `${x}%`;
            star.style.top = `${y}%`;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.setProperty('--duration', `${duration}s`);
            star.style.setProperty('--opacity', Math.random() * 0.5 + 0.1);
            
            container.appendChild(star);
        }
    }

    window.addEventListener('load', function() {
        // 1. Inicializa el reloj inmediatamente
        updateClock();
        initOrbitalClock(); // Inicializar reloj orbital
        initStars();
        renderPillars();
    });

    // --- MODALES GENERALES ---
    function openModal(title, content) {
        const titleEl = document.getElementById('gen-modal-title');
        const bodyEl = document.getElementById('gen-modal-body');
        const modalEl = document.getElementById('general-modal');

        if(titleEl) titleEl.innerHTML = title;
        if(bodyEl) bodyEl.innerHTML = content;
        if(modalEl) modalEl.classList.remove('hidden');
    }

    function closeGenModal() {
        const modalEl = document.getElementById('general-modal');
        if(modalEl) modalEl.classList.add('hidden');
        stopBreathing(); // Detener respiración si está activa
        if(typeof gameTimerInterval !== 'undefined') clearInterval(gameTimerInterval);
    }

    function openSettingsModal() {
        const content = `
            <div style="text-align:left;">
                <p style="font-size:0.9em; color:var(--text-secondary); margin-bottom:15px;">Sigue estos pasos para configurar tu experiencia:</p>

                <div class="settings-btn" onclick="openNotificationModal()">
                    <div class="icon-container"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg></div>
                    <div class="text">
                        <strong>Recordatorio Diario</strong>
                        <span>Configura una notificación diaria.</span>
                    </div>
                </div>
                <div class="settings-btn" onclick="openDataModal()">
                    <div class="icon-container"><svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg></div>
                    <div class="text">
                        <strong>Guardar / Restaurar Datos</strong>
                        <span>Exporta o importa tus datos locales.</span>
                    </div>
                </div>
                <div class="settings-btn" onclick="openLoginModal()">
                    <div class="icon-container"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></div>
                    <div class="text">
                        <strong>Cuenta / Login</strong>
                        <span>Ingresa para sincronizar.</span>
                    </div>
                </div>
                <div class="settings-btn" onclick="openPrivacyModal()">
                    <div class="icon-container"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></div>
                    <div class="text">
                        <strong>Aviso de Privacidad</strong>
                        <span>Consulta cómo tratamos tus datos.</span>
                    </div>
                </div>
                <div class="settings-btn" onclick="openContactModal()">
                    <div class="icon-container"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div>
                    <div class="text">
                        <strong>Soporte y Contacto</strong>
                        <span>¿Dudas? Escríbenos a odonerapp@gmail.com</span>
                    </div>
                </div>
            </div>
        `;
        openModal('⚙️ Ajustes y Utilidades', content);
    }

    function openContactModal() {
        const content = `
            <div style="text-align: center;">
                <h3 style="color: var(--neon-blue);">Contacto y Soporte</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Envíanos tus dudas o comentarios.</p>
                
                <form name="contact" method="POST" data-netlify="true" onsubmit="submitContactForm(event)">
                    <input type="hidden" name="form-name" value="contact">
                    
                    <input type="text" name="name" placeholder="Tu Nombre" required
                        style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary);">
                    
                    <input type="email" name="email" placeholder="Tu Correo" required
                        style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary);">
                    
                    <textarea name="message" placeholder="Tu Mensaje..." required rows="4"
                        style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary); resize: vertical; font-family: inherit;"></textarea>
                    
                    <button type="submit" class="btn" style="width: 100%;">ENVIAR MENSAJE</button>
                </form>
            </div>
        `;
        openModal("✉️ Contacto", content);
    }

    function submitContactForm(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        
        fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData).toString()
        })
        .then(() => {
            alert("¡Mensaje enviado con éxito!");
            closeGenModal();
        })
        .catch((error) => alert("Error al enviar: " + error));
    }

    function openPrivacyModal() {
        const content = `
            <div style="text-align: left; color: var(--text-primary); font-size: 0.9em; line-height: 1.5; max-height: 60vh; overflow-y: auto; padding-right: 5px;">
                <h3 style="color: var(--neon-blue); margin-top: 0;">Aviso de Privacidad Integral</h3>
                <p style="font-size: 0.8em; opacity: 0.7;">Última actualización: ${new Date().toLocaleDateString()}</p>
                
                <p><strong>Oddoner</strong> ("la Aplicación") se compromete a proteger tu privacidad. Este aviso detalla cómo tratamos tu información.</p>
                
                <h4 style="color: var(--neon-blue); margin-bottom: 5px;">1. Datos que Recopilamos</h4>
                <ul style="padding-left: 20px; margin-top: 5px;">
                    <li><strong>Datos en Dispositivo (Local):</strong> La mayoría de tu información, incluyendo tu diario personal, fecha de sobriedad, gemas de la mochila y configuraciones, se almacena únicamente en la memoria de tu dispositivo (LocalStorage).</li>
                    <li><strong>Datos de Registro (Nube):</strong> Si decides crear una cuenta, recopilamos tu nombre, correo electrónico, contraseña, edad y género para gestionar tu identidad en la aplicación.</li>
                    <li><strong>Datos de Sensores:</strong> Para funciones como "Pupila Dimensional", "Nebulosa" o "Protocolo VENC", solicitamos acceso a la cámara, micrófono o giroscopio. Estos datos se procesan en tiempo real en tu dispositivo y <strong>no</strong> se envían a nuestros servidores ni se almacenan.</li>
                </ul>

                <h4 style="color: var(--neon-blue); margin-bottom: 5px;">2. Finalidad del Tratamiento</h4>
                <p style="margin-top: 5px;">Utilizamos la información para:</p>
                <ul style="padding-left: 20px; margin-top: 5px;">
                    <li>Proporcionar herramientas de seguimiento de sobriedad y salud mental.</li>
                    <li>Permitir el respaldo y sincronización de datos (solo usuarios registrados).</li>
                    <li>Mejorar la funcionalidad de la aplicación.</li>
                </ul>

                <h4 style="color: var(--neon-blue); margin-bottom: 5px;">3. Tus Derechos</h4>
                <p style="margin-top: 5px;">Tienes derecho a acceder, rectificar, cancelar u oponerte al tratamiento de tus datos. Puedes eliminar tus datos locales usando la opción "Gestión de Datos" o solicitar la baja de tu cuenta contactándonos.</p>

                <h4 style="color: var(--neon-blue); margin-bottom: 5px;">4. Contacto</h4>
                <p style="margin-top: 5px;">Para cualquier duda sobre privacidad, contáctanos en: <strong>odonerapp@gmail.com</strong></p>
            </div>
            <button class="btn" onclick="openSettingsModal()" style="width: 100%; margin-top: 15px;">Volver a Ajustes</button>
        `;
        openModal("🔒 Privacidad", content);
    }

    function openAnimatedModal(title, tasks, concept, icon) {
        const tasksHtml = tasks.map(task => `
            <div class="task-item-container">
                <div class="task-circle">${task.icon}</div>
                <div class="task-text">${task.text}</div>
            </div>
        `).join('');

        let body = `
            <div class="concept-header">${concept}</div>
            <div class="task-list">
                ${tasksHtml}
            </div>
        `;

        // Contenido específico para el modal del Niño Interior
        if (title.includes('Niño Interior')) {
            const tempEntry = loadTempEntry(INNER_CHILD_KEY);
            const historyLines = loadJournalHistory(INNER_CHILD_KEY);
            const historyHtml = generateHistoryHtml(historyLines);
            body += `
                <textarea id="inner-child-textarea" 
                    placeholder="Escribe lo que tu niño interior necesita decir..."
                    oninput="saveTempEntry(INNER_CHILD_KEY, 'inner-child-textarea')">${tempEntry}</textarea>

                <button class="btn" style="background: var(--neon-blue); margin-top: 10px;"
                        onclick="saveNewEntry(INNER_CHILD_KEY, 'inner-child-textarea', 'Niño Interior')">
                    💾 GUARDAR REGISTRO DEL NIÑO INTERIOR
                </button>

                <div class="history-container">
                    <h4>Historial del Niño Interior (${historyLines.length})</h4>
                    ${historyHtml}
                </div>
            `;
        }

        openModal(`${icon} ${title}`, body);
    }

    function openInnerChildModal() {
        openAnimatedModal(
            'Sanando al Niño Interior',
            [
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>', text: '<strong>Visualiza</strong> a tu yo de 5 años. Nota sus heridas y necesidades.'},
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>', text: '<strong>Pregúntale:</strong> *“¿Qué necesitas de mí hoy?”* Dale un abrazo virtual.'},
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>', text: '<strong>Prométele</strong> que le darás seguridad, límites o afecto que le faltó.'}
            ],
            'Tu parte emocional con las heridas y las necesidades no cubiertas de la infancia.',
            '🧸'
        );
    }
    
    function openTallerModal() {
        const content = `
            <div class="menu-btn-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="menu-btn" onclick="openJournalModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></div>
                    <div class="text">Diario</div>
                </div>
                <div class="menu-btn" onclick="openMochilaModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M20 8h-3V6.21c0-2.61-1.91-4.94-4.51-5.19C9.51.74 7 3.08 7 6v2H4v14h16V8zm-8-2c1.1 0 2 .9 2 2v2h-4V6c0-1.1.9-2 2-2zm0 12c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg></div>
                    <div class="text">Mochila</div>
                </div>
                <div class="menu-btn" onclick="openInnerChildModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></div>
                    <div class="text">Niño Interior</div>
                </div>
                <div class="menu-btn" onclick="openOrganizerModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></div>
                    <div class="text">Organizador</div>
                </div>                                
                <div class="menu-btn" onclick="openTimeCapsuleModal()">
                    <div class="icon" style="font-size: 2em;">⏳</div>
                    <div class="text">Cápsula Tiempo</div>
                </div>
            </div>`;
        openModal('Mi Trabajo Interior', content);
    }

    function openAAMenuModal() {
        const content = `
            <div class="menu-btn-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="menu-btn" onclick="openAAModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 4h2v5l-1-1.5L9 9V4zm9 16H6V4h1v9l3-2.25L13 13V4h5v16z"/></svg></div>
                    <div class="text">Alcohólicos Anónimos</div>
                </div>
                <div class="menu-btn" onclick="openAAStepsModal()">
                    <div class="icon" style="font-size: 1.5em;">👣</div>
                    <div class="text">12 Pasos</div>
                </div>
                <div class="menu-btn" onclick="openAATraditionsModal()">
                    <div class="icon" style="font-size: 1.5em;">📜</div>
                    <div class="text">12 Tradiciones</div>
                </div>
                <div class="menu-btn" onclick="openMoralInventoryModal()">
                    <div class="icon" style="font-size: 2em;">⚖️</div>
                    <div class="text">Inventario Moral</div>
                </div>
                <div class="menu-btn" onclick="openDetectorModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M10.29 3.86c-1.76.36-3.29 1.57-4.05 3.18-.76 1.61-.62 3.52.38 5.02l.01.01c-.82-.24-1.7-.21-2.5.11-.8.32-1.46.92-1.85 1.69-.39.77-.46 1.67-.2 2.5.26.83.83 1.53 1.59 1.96l.01.01c-.36.68-.46 1.48-.28 2.24.18.76.64 1.43 1.28 1.89.64.46 1.42.66 2.19.56.77-.1 1.48-.48 1.99-1.05l.01-.01c.51.57 1.22.95 1.99 1.05.77.1 1.55-.1 2.19-.56.64-.46 1.1-1.13 1.28-1.89.18-.76.08-1.56-.28-2.24l.01-.01c.76-.43 1.33-1.13 1.59-1.96.26-.83.19-1.73-.2-2.5-.39-.77-1.05-1.37-1.85-1.69-.8-.32-1.68-.35-2.5-.11l.01-.01c1-1.5 1.14-3.41.38-5.02-.76-1.61-2.29-2.82-4.05-3.18-1.76-.36-3.57.17-4.83 1.43L12 5.59l1.43-1.43c-1.26-1.26-3.07-1.79-4.83-1.43z"/></svg></div>
                    <div class="text">Detector de Impulsos</div>
                </div>
                <div class="menu-btn" onclick="openAnxietyCapsuleModal()" style="background: rgba(255, 82, 82, 0.15); border: 1px solid #ff5252;">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg></div>
                    <div class="text">Cápsula de Ansiedad</div>
                </div>
            </div>
        `;
        openModal('Alcohólicos Anónimos', content);
    }

    function openExperienciasModal() {
        const content = `
            <div class="menu-btn-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="menu-btn" onclick="openBreathingModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M12.5 2C15 2 17 4 17 6.5S15 11 12.5 11H4v-2h8.5c1.38 0 2.5-1.12 2.5-2.5S13.88 4 12.5 4c-1.14 0-2.09.76-2.41 1.79l-1.9-.63C8.59 3.28 10.41 2 12.5 2zM16 13c2.76 0 5 2.24 5 5s-2.24 5-5 5-5-2.24-5-5v-3h5zm0 2h-3v3c0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></div>
                    <div class="text">Respiración</div>
                </div>
                <div class="menu-btn" onclick="openCognitiveGameModal()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5C13 2.12 11.88 1 10.5 1S8 2.12 8 3.5V5H4c-1.1 0-1.99.9-1.99 2v3.8H3.5c1.49 0 2.7 1.21 2.7 2.7s-1.21 2.7-2.7 2.7H2V20c0 1.1.9 2 2 2h3.8v-1.5c0-1.49 1.21-2.7 2.7-2.7 1.49 0 2.7 1.21 2.7 2.7V22H17c1.1 0 2-.9 2-2v-4h1.5c1.38 0 2.5-1.12 2.5-2.5S21.88 11 20.5 11z"/></svg></div>
                    <div class="text">Gimnasio Mental</div>
                </div>
                <div class="menu-btn" onclick="openColorMemoryGameLevels()">
                    <div class="icon">🎨</div>
                    <div class="text">Memoria de Colores</div>
                </div>
               
                <div class="menu-btn" onclick="openNeuroGate()">
                    <div class="icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg></div>
                    <div class="text">Neuro-Gate (Test)</div>
                </div>
            </div>
        `;
        openModal('Experiencias Interactivas', content);
    }
    // --- FUNCIÓN DEL BOTÓN DE CRISIS ---
    function openCrisisModal() {
        const currentContact = getEmergencyContact();
        const smsLink = `sms:${currentContact}?body=No%20estoy%20bien.%20Necesito%20compañía%20ahora.`;
        const displayContact = currentContact.includes('12345678') ? "SIN ASIGNAR (EJEMPLO)" : currentContact;

        const content = `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 10px;">
                <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: var(--color-alert);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                <h2 style="color: var(--color-alert); margin: 0;">¡HAZ UNA PAUSA!</h2>
            </div>
            <p style="font-size: 1.1em; color: var(--text-primary); margin-bottom: 30px;">
                Tranquilo, la ansiedad y la depresión pasarán. Es hora de creer en un Poder Superior.
            </p>

            <a id="btn-send-sms" href="${smsLink}"
               class="btn"
               style="width: 80%; max-width: 300px; margin-top:5px; margin-bottom: 15px; background: var(--color-alert); color: white;">
                <svg viewBox="0 0 24 24" style="vertical-align:middle; margin-right:5px;"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/></svg> Enviar mensaje a mi contacto seguro
            </a>
            
            <div class="crisis-config">
                <p style="font-size: 0.9em; font-weight: bold; color: var(--text-primary);">
                    📞 Contacto Seguro Guardado: <span style="color: var(--color-alert);">${displayContact}</span>
                </p>
                <label for="emergency-contact-input" style="font-size: 0.8em; color: var(--text-primary); display: block; margin-top: 10px;">
                    Editar o añadir tu contacto seguro (incluye código de país, ej: +52155...)
                </label>
                <input type="tel" id="emergency-contact-input" 
                       placeholder="+5215512345678" 
                       value="${currentContact.includes('12345678') ? '' : currentContact}" 
                       onblur="saveEmergencyContact()">
                <p style="font-size: 0.75em; color: var(--text-primary); opacity: 0.7; margin-top: 5px;">
                    Se guarda automáticamente al salir del campo.
                </p>
            </div>


            <div style="margin-top:20px; font-size:0.95em; opacity:0.9; line-height:1.4; text-align: left; max-width: 350px; margin: 20px auto;">
              <p><strong>¿Por qué no te has suicidado?</strong></p>

              <p>
                No quieres morir.  
                No quieres estar solo.  
                No sabes cómo parar de sufrir.
              </p>

              <p>
                Esto no es la ayuda.  
                <strong>Es solo la guía.</strong>
              </p>

              <p>
                Ve a un grupo de <strong>AA</strong>.  
                Habla con alguien hoy.
              </p>
            </div>
            
            <div style="margin-top:25px; font-size:0.9em; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; color: var(--text-primary);">
              <p><strong>México - Líneas de Ayuda</strong></p>
              <p>🚨 Emergencias: <strong style="color: var(--color-alert);">911</strong></p>
              <p>☎️ Línea de la Vida: <strong style="color: var(--neon-blue);">800 911 2000</strong> (24/7)</p>
            </div>
        `;
        openModal("🚨 EMERGENCIA / CRISIS", content);
    }
    // --- FIN FUNCIÓN DEL BOTÓN DE CRISIS ---

    // --- FUNCIÓN PRINCIPAL AA MODAL (CON MAPA) ---
    function openAAModal() {
        const now = new Date().getTime();
        const diff = now - startTime;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        let chipClass = 'chip-silver';
        let chipText = '24H';
        let chipLabel = 'Comienzo';

        if (days >= 365) { chipClass = 'chip-bronze'; chipText = Math.floor(days/365)+' AÑOS'; chipLabel = '¡Milagro!'; }
        else if (days >= 270) { chipClass = 'chip-purple'; chipText = '9 MESES'; chipLabel = 'Constancia'; }
        else if (days >= 180) { chipClass = 'chip-blue'; chipText = '6 MESES'; chipLabel = 'Voluntad'; }
        else if (days >= 90) { chipClass = 'chip-green'; chipText = '3 MESES'; chipLabel = 'Esperanza'; }
        else if (days >= 60) { chipClass = 'chip-gold'; chipText = '2 MESES'; chipLabel = 'Progreso'; }
        else if (days >= 30) { chipClass = 'chip-red'; chipText = '1 MES'; chipLabel = 'Despertar'; }

        const AA_STEPS = [
            "Admitimos que éramos impotentes ante el alcohol, que nuestras vidas se habían vuelto ingobernables.",
            "Llegamos a creer que un Poder superior a nosotros mismos podría devolvernos el sano juicio.",
            "Decidimos poner nuestras voluntades y nuestras vidas al cuidado de Dios, como nosotros lo concebimos.",
            "Sin miedo hicimos un minucioso inventario moral de nosotros mismos.",
            "Admitimos ante Dios, ante nosotros mismos, y ante otro ser humano, la naturaleza exacta de nuestros defectos.",
            "Estuvimos enteramente dispuestos a dejar que Dios nos liberase de todos estos defectos de carácter.",
            "Humildemente le pedimos que nos liberase de nuestros defectos.",
            "Hicimos una lista de todas aquellas personas a quienes habíamos ofendido y estuvimos dispuestos a reparar el daño que les causamos.",
            "Reparamos directamente a cuantos nos fue posible el daño causado, excepto cuando el hacerlo implicaba perjuicio para ellos o para otros.",
            "Continuamos haciendo nuestro inventario personal y cuando nos equivocábamos lo admitíamos inmediatamente.",
            "Buscamos a través de la oración y la meditación mejorar nuestro contacto consciente con Dios, como nosotros lo concebimos, pidiéndole solamente que nos dejase conocer su voluntad para con nosotros y nos diese la fortaleza para cumplirla.",
            "Habiendo obtenido un despertar espiritual como resultado de estos pasos, tratamos de llevar este mensaje a los alcohólicos y de practicar estos principios en todos nuestros asuntos."
        ];
        const stepsListHtml = `<ul class="aa-steps-list">${AA_STEPS.map(step => `<li>${step}</li>`).join('')}</ul>`;

        const newFormHtml = `
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 20px;">
                <h3 style="color: var(--text-primary); text-align: center;">AA · Práctica Diaria</h3>
                <div class="aa-form-section">
                    <label for="decision">Decisión del día</label>
                    <select id="decision">
                        <option>Elegí no reaccionar</option>
                        <option>Elegí pedir ayuda</option>
                        <option>Elegí decir la verdad</option>
                        <option>Elegí soltar</option>
                        <option>No supe qué elegir</option>
                    </select>
                </div>
                <div class="aa-form-section">
                    <label for="calma">Calma (0-10)</label>
                    <input type="range" min="0" max="10" id="calma" value="5">
                </div>
                <div class="aa-form-section">
                    <label for="honestidad">Honestidad (0-10)</label>
                    <input type="range" min="0" max="10" id="honestidad" value="5">
                </div>
                <div class="aa-form-section">
                    <label for="conexion">Conexión (0-10)</label>
                    <input type="range" min="0" max="10" id="conexion" value="5">
                </div>
                <div class="aa-form-section">
                    <label for="microacto">Microacto consciente</label>
                    <select id="microacto">
                        <option>Escuché sin interrumpir</option>
                        <option>Esperé antes de responder</option>
                        <option>Acepté incomodidad</option>
                        <option>Me retiré a tiempo</option>
                    </select>
                </div>
                <div class="aa-form-section">
                    <label for="pensamiento">Pensamiento no dicho</label>
                    <textarea id="pensamiento" rows="3"></textarea>
                </div>
                <button class="btn" style="width: 100%;" onclick="guardarDia()">Guardar día 🙏</button>
            </div>
        `;

        const content = `
            <div style="text-align:center; margin-bottom:15px; padding:10px; background:var(--surface-hover); border-radius:15px; display:flex; align-items:center; justify-content:space-around;">
                <div>
                    <h4 style="margin:0; color:var(--text-primary); font-size:0.9em;">Tu Ficha</h4>
                    <div class="aa-chip ${chipClass}">
                        <div style="text-align:center; line-height:1;">
                            <span style="display:block; font-size:0.9em;">${chipText}</span>
                        </div>
                    </div>
                </div>
                <div style="text-align:left; max-width:60%;">
                    <p style="margin:0; font-weight:bold; color:var(--neon-blue); font-size:1.1em;">${chipLabel}</p>
                    <p style="margin:0; font-size:0.8em; color:var(--text-primary);">Llevas ${days} días de victoria.</p>
                </div>
            </div>

            ${newFormHtml}

            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 20px;">
                <h3 style="color: var(--text-primary); margin-bottom: 5px;">Los Doce Pasos (Base)</h3>
                <p style="font-size: 0.8em; color: var(--text-primary); opacity: 0.7; margin-bottom: 10px;">Versión resumida de los principios de acción</p>
                ${stepsListHtml}
            </div>
              
            <div style="margin-top: 20px; border: 1px solid var(--neon-blue); border-radius: 10px; padding: 20px; text-align: center; background: rgba(75, 144, 255, 0.05);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px;">
                    <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--neon-blue);"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>
                    <h4 style="color: var(--neon-blue); margin: 0;">Foco Visual</h4>
                </div>
                <div style="width: 60px; height: 60px; background: var(--neon-blue); border-radius: 50%; margin: 0 auto 20px auto; animation: breathe 4s infinite ease-in-out; box-shadow: 0 0 20px var(--neon-blue);"></div>
                <p style="font-size: 0.95em; color: var(--text-primary); font-style: italic; line-height: 1.5;">
                    "Foco visual: Al mirar el círculo expandirse y contraerse, el cerebro deja de rumiar pensamientos negativos."
                </p>
            </div>
              
            <p style="text-align: center; margin-top: 20px; font-weight: bold; font-size: 0.9em; color: var(--text-primary);">
                ¡Un día a la vez!
            </p>
        `;
        openModal("📖 Alcohólicos Anónimos", content);
    }

    function openAAStepsModal() {
        const AA_STEPS = [
            "Admitimos que éramos impotentes ante el alcohol, que nuestras vidas se habían vuelto ingobernables.",
            "Llegamos a creer que un Poder superior a nosotros mismos podría devolvernos el sano juicio.",
            "Decidimos poner nuestras voluntades y nuestras vidas al cuidado de Dios, como nosotros lo concebimos.",
            "Sin miedo hicimos un minucioso inventario moral de nosotros mismos.",
            "Admitimos ante Dios, ante nosotros mismos, y ante otro ser humano, la naturaleza exacta de nuestros defectos.",
            "Estuvimos enteramente dispuestos a dejar que Dios nos liberase de todos estos defectos de carácter.",
            "Humildemente le pedimos que nos liberase de nuestros defectos.",
            "Hicimos una lista de todas aquellas personas a quienes habíamos ofendido y estuvimos dispuestos a reparar el daño que les causamos.",
            "Reparamos directamente a cuantos nos fue posible el daño causado, excepto cuando el hacerlo implicaba perjuicio para ellos o para otros.",
            "Continuamos haciendo nuestro inventario personal y cuando nos equivocábamos lo admitíamos inmediatamente.",
            "Buscamos a través de la oración y la meditación mejorar nuestro contacto consciente con Dios, como nosotros lo concebimos, pidiéndole solamente que nos dejase conocer su voluntad para con nosotros y nos diese la fortaleza para cumplirla.",
            "Habiendo obtenido un despertar espiritual como resultado de estos pasos, tratamos de llevar este mensaje a los alcohólicos y de practicar estos principios en todos nuestros asuntos."
        ];
        const stepsListHtml = `<ul class="aa-steps-list">${AA_STEPS.map(step => `<li>${step}</li>`).join('')}</ul>`;
        openModal("👣 Los 12 Pasos", stepsListHtml);
    }

    function openAATraditionsModal() {
        const AA_TRADITIONS = [
            "Nuestro bienestar común debe tener la preferencia; la recuperación personal depende de la unidad de A.A.",
            "Para el propósito de nuestro grupo sólo existe una autoridad fundamental: un Dios amoroso tal como se exprese en la conciencia de nuestro grupo. Nuestros líderes no son más que servidores de confianza; no gobiernan.",
            "El único requisito para ser miembro de A.A. es el deseo de dejar la bebida.",
            "Cada grupo debe ser autónomo, excepto en asuntos que afecten a otros grupos o a Alcohólicos Anónimos considerado como un todo.",
            "Cada grupo tiene un solo objetivo primordial: llevar el mensaje al alcohólico que aún está sufriendo.",
            "Un grupo de A.A. nunca debe respaldar, financiar o prestar el nombre de A.A. a ninguna entidad allegada o empresa ajena, para evitar que los problemas de dinero, propiedad y prestigio nos desvíen de nuestro objetivo primordial.",
            "Todo grupo de A.A. debe mantenerse completamente a sí mismo, negándose a recibir contribuciones de afuera.",
            "A.A. nunca tendrá carácter profesional, pero nuestros centros de servicio pueden emplear trabajadores especiales.",
            "A.A. como tal nunca debe ser organizada; pero podemos crear juntas o comités de servicio que sean directamente responsables ante aquellos a quienes sirven.",
            "Alcohólicos Anónimos no tiene opinión acerca de asuntos ajenos a sus actividades; por consiguiente su nombre nunca debe mezclarse en polémicas públicas.",
            "Nuestra política de relaciones públicas se basa más bien en la atracción que en la promoción; necesitamos mantener siempre nuestro anonimato personal ante la prensa, la radio y el cine.",
            "El anonimato es la base espiritual de todas nuestras Tradiciones, recordándonos siempre anteponer los principios a las personalidades."
        ];
        const traditionsListHtml = `<ul class="aa-steps-list">${AA_TRADITIONS.map(trad => `<li>${trad}</li>`).join('')}</ul>`;
        openModal("📜 Las 12 Tradiciones", traditionsListHtml);
    }

    function openMoralInventoryModal() {
        const content = `
            <div style="text-align: left;">
                <h3 style="color: var(--neon-blue); text-align: center;">Inventario Moral (Paso 4)</h3>
                <p style="font-size: 0.9em; color: var(--text-secondary); text-align: center; margin-bottom: 20px;">
                    Identifica, admite y corrige.
                </p>

                <label style="display:block; margin-top:10px; font-weight:bold; color:var(--text-primary);">1. ¿Quién o qué te molesta?</label>
                <input type="text" id="inv-persona" placeholder="Persona, Institución o Principio" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:var(--bg-app); color:white;">

                <label style="display:block; margin-top:10px; font-weight:bold; color:var(--text-primary);">2. La Causa (¿Qué pasó?)</label>
                <textarea id="inv-causa" rows="2" placeholder="Breve descripción..." style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:var(--bg-app); color:white;"></textarea>

                <label style="display:block; margin-top:10px; font-weight:bold; color:var(--text-primary);">3. ¿Qué parte de ti fue afectada?</label>
                <select id="inv-defecto" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:var(--bg-app); color:white;">
                    <option value="Autoestima">Autoestima</option>
                    <option value="Seguridad">Seguridad (Económica/Emocional)</option>
                    <option value="Ambiciones">Ambiciones</option>
                    <option value="Relaciones">Relaciones Personales</option>
                </select>

                <label style="display:block; margin-top:10px; font-weight:bold; color:var(--text-primary);">4. Mi Parte (El error propio)</label>
                <select id="inv-error" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:var(--bg-app); color:white;">
                    <option value="Egoísmo">Egoísmo</option>
                    <option value="Deshonestidad">Deshonestidad</option>
                    <option value="Miedo">Miedo</option>
                    <option value="Resentimiento">Resentimiento</option>
                </select>

                <button class="btn" onclick="saveMoralInventory()" style="width:100%; margin-top:20px;">GUARDAR EN HISTORIAL</button>
                
                <div id="inv-history" style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <h4 style="color:var(--text-primary);">Historial Reciente</h4>
                    <div id="inv-list"></div>
                </div>
            </div>
        `;
        openModal("⚖️ Inventario Moral", content);
        loadMoralInventoryHistory();
    }

    function saveMoralInventory() {
        const persona = document.getElementById('inv-persona').value;
        const causa = document.getElementById('inv-causa').value;
        const defecto = document.getElementById('inv-defecto').value;
        const error = document.getElementById('inv-error').value;

        if(!persona || !causa) return alert("Completa los campos principales.");

        const entry = {
            date: new Date().toLocaleDateString(),
            persona, causa, defecto, error
        };

        const history = JSON.parse(localStorage.getItem(MORAL_INVENTORY_KEY) || '[]');
        history.unshift(entry); // Add to top
        localStorage.setItem(MORAL_INVENTORY_KEY, JSON.stringify(history));

        alert("Inventario guardado. Has dado un paso hacia la libertad.");
        
        // Clear inputs
        document.getElementById('inv-persona').value = '';
        document.getElementById('inv-causa').value = '';
        
        loadMoralInventoryHistory();
    }

    function loadMoralInventoryHistory() {
        const list = document.getElementById('inv-list');
        if(!list) return;
        
        const history = JSON.parse(localStorage.getItem(MORAL_INVENTORY_KEY) || '[]');
        
        if(history.length === 0) {
            list.innerHTML = '<p style="opacity:0.6; font-size:0.9em;">No hay inventarios aún.</p>';
            return;
        }

        let html = '';
        history.slice(0, 5).forEach(item => {
            html += `
                <div style="background:var(--surface-hover); padding:10px; border-radius:8px; margin-bottom:10px; border-left:3px solid var(--neon-blue);">
                    <div style="font-weight:bold; color:var(--text-primary);">${item.persona} <span style="font-size:0.8em; opacity:0.7; float:right;">${item.date}</span></div>
                    <div style="font-size:0.9em; color:var(--text-secondary); margin-top:5px;">"${item.causa}"</div>
                    <div style="font-size:0.8em; color:var(--neon-blue); margin-top:5px;">Fallo: ${item.error} | Afectó: ${item.defecto}</div>
                </div>
            `;
        });
        list.innerHTML = html;
    }

    // --- FUNCIÓN DE DONACIÓN (MODIFICADA: Apoyo al Proyecto) ---
    function openDonationModal() {
        // Usa la variable PAYPAL_LINK definida al inicio del script
        const content = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <h2 style="color: var(--neon-blue); margin: 0;">Apoyo al Proyecto</h2>
            </div>
            <p style="font-size: 1em; color: var(--text-primary); margin-bottom: 25px;">
                Si esta herramienta te ha brindado <strong>valor</strong> o te ha ayudado en tu camino,
                puedes apoyar el desarrollo y mantenimiento del proyecto con una 
                <strong>contribución voluntaria</strong>.
                <br>
                ¡Gracias por ayudar a mantener Oddoner activo!
            </p>
            
            <div style="margin-top: 30px;">
                <a href="${PAYPAL_LINK}" target="_blank" class="btn" 
                   style="background: var(--neon-blue); color: white; width: 80%; max-width: 300px; padding: 12px 0;">
                    ⭐ Contribuir al Mantenimiento
                </a>
                <p style="font-size: 0.85em; color: var(--text-primary); opacity: 0.8; margin-top: 15px;">
                    (Se abrirá el link de pago en una nueva pestaña)
                </p>
            </div>
            
            <div style="margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 15px;">
                <p style="font-size: 0.8em; color: var(--text-primary); font-style: italic;">
                    Nota: Esta aplicación es un proyecto personal y siempre será gratuita.
                </p>
            </div>
        `;
        
        openModal("⭐ Apoyar el Proyecto", content);
    }
    // --- FIN FUNCIÓN DE DONACIÓN ---


    // --- FUNCIÓN DE NOTIFICACIONES (NUEVA) ---
    function openNotificationModal() {
        const savedTime = localStorage.getItem(NOTIFICATION_KEY) || '10:00';
        const savedMessage = localStorage.getItem(NOTIFICATION_MESSAGE_KEY) || '¡Hora de tu inventario diario o meditación!';
        
        const content = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                <h2 style="color: var(--neon-blue); margin: 0;">Recordatorio Diario</h2>
            </div>
            <p style="font-size: 0.9em; color: var(--text-primary); margin-bottom: 20px;">
                Configura una hora para recibir una alerta automática
                (Notificación) en tu celular.
            </p>

            <label for="reminder-time" style="display: block; text-align: left; max-width: 250px; margin: 0 auto; margin-top: 15px; color: var(--text-primary); font-weight: bold;">
                Elige la hora (HH:MM):
            </label>
            <input type="time" id="reminder-time" value="${savedTime}" 
                   style="width: 80%; max-width: 250px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; font-size: 1.1em; margin-bottom: 20px; color: var(--text-primary); background: var(--bg-app);">
            
            <label for="reminder-message" style="display: block; text-align: left; max-width: 250px; margin: 0 auto; margin-top: 15px; color: var(--text-primary); font-weight: bold;">
                Mensaje de la alerta:
            </label>
            <input type="text" id="reminder-message" value="${savedMessage}" 
                   placeholder="Mensaje de recordatorio..."
                   style="width: 80%; max-width: 250px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 20px; color: var(--text-primary); background: var(--bg-app);">

            <button class="btn" onclick="saveReminderSettings()">
                💾 GUARDAR RECORDATORIO
            </button>
            
            <p style="font-size: 0.8em; color: var(--text-secondary); opacity: 0.7; margin-top: 20px;">
                *Nota: Al guardar, te pedirá permiso para enviar notificaciones. 
                La app debe estar abierta o minimizada para funcionar.
            </p>
        `;
        openModal("🔔 Recordatorio Diario", content);
    }

    function saveReminderSettings() {
        const timeInput = document.getElementById('reminder-time');
        const messageInput = document.getElementById('reminder-message');
        
        if (timeInput.value) {
            localStorage.setItem(NOTIFICATION_KEY, timeInput.value);
            localStorage.setItem(NOTIFICATION_MESSAGE_KEY, messageInput.value.trim() || '¡Recordatorio de Oddoner!');
            
            // SOLICITAR PERMISO DE NOTIFICACIONES REALES
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        // Prueba inmediata
                        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                             navigator.serviceWorker.ready.then(reg => {
                                 reg.showNotification('Oddoner', {
                                     body: '✅ Notificaciones activadas correctamente.',
                                     icon: 'image/icon-192.png',
                                     vibrate: [100, 50, 100]
                                 });
                             });
                        } else {
                            new Notification('Oddoner', { body: '✅ Notificaciones activadas correctamente.' });
                        }
                    } else {
                        alert("Para recibir alertas reales, debes permitir las notificaciones en tu navegador.");
                    }
                });
            }

            alert(`Recordatorio guardado para las ${timeInput.value}.`);
            closeGenModal();
        } else {
            alert("Por favor, selecciona una hora válida."); 
        }
    }
    
    // Función que utiliza la variable global 'lastAlertMinute'
    function checkNotifications() {
        const savedTime = localStorage.getItem(NOTIFICATION_KEY);
        
        if (!savedTime) return;
        
        const now = new Date();
        const currentHourMinute = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        if (currentHourMinute === savedTime) {
            
            if (now.getMinutes() !== lastAlertMinute) {
                
                const message = localStorage.getItem(NOTIFICATION_MESSAGE_KEY) || '¡Recordatorio de Oddoner!';
                
                // INTENTAR NOTIFICACIÓN NATIVA
                if ("Notification" in window && Notification.permission === "granted") {
                    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.ready.then(reg => {
                            reg.showNotification('Oddoner', {
                                body: message,
                                icon: 'image/icon-192.png',
                                vibrate: [200, 100, 200],
                                tag: 'daily-reminder'
                            });
                        });
                    } else {
                        new Notification('Oddoner', {
                            body: message,
                            icon: 'image/icon-192.png'
                        });
                    }
                } else {
                    // Fallback si no hay permiso
                    alert(`🔔 ${message}`);
                }
                
                lastAlertMinute = now.getMinutes(); 
            }
        }
    }
    // --- FIN FUNCIÓN DE NOTIFICACIONES ---


    // --- FUNCIONES DE OTROS MODALES ---
    function openOrganizerModal() {
        const content = `
            <!-- TAREAS -->
            <section class="organizer-section">
                <h2><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--neon-blue);vertical-align:middle;margin-right:8px;"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Tareas</h2>
                <div class="organizer-input-group">
                    <input id="tareaTexto" placeholder="Nueva tarea...">
                    <input type="date" id="tareaFecha">
                    <button onclick="agregarTarea()"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
                </div>
                <ul id="tareas" class="organizer-list"></ul>
            </section>

            <!-- METAS -->
            <section class="organizer-section">
                <h2><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--neon-blue);vertical-align:middle;margin-right:8px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> Metas</h2>
                <div class="organizer-input-group">
                    <input id="metaTexto" placeholder="Nueva meta...">
                    <button onclick="agregarMeta()"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
                </div>
                <ul id="metas" class="organizer-list"></ul>
            </section>

            <!-- HABITOS -->
            <section class="organizer-section">
                <h2><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:var(--neon-blue);vertical-align:middle;margin-right:8px;"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg> Hábitos</h2>
                <div class="organizer-input-group">
                    <input id="habitoTexto" placeholder="Nuevo hábito...">
                    <button onclick="agregarHabito()"><svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
                </div>
                <ul id="habitos" class="organizer-list"></ul>
            </section>
        `;
        openModal("📅 Organizador", content);

        // Llamar a las funciones de renderizado después de que el modal esté en el DOM
        setTimeout(() => {
            mostrarTareas();
            mostrarMetas();
            mostrarHabitos();
        }, 0);
    }

    function openInnerChildModal() {
        openAnimatedModal(
            'Sanando al Niño Interior',
            [
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>', text: '<strong>Visualiza</strong> a tu yo de 5 años. Nota sus heridas y necesidades.'},
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>', text: '<strong>Pregúntale:</strong> *“¿Qué necesitas de mí hoy?”* Dale un abrazo virtual.'},
                {icon: '<svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>', text: '<strong>Prométele</strong> que le darás seguridad, límites o afecto que le faltó.'}
            ],
            'Tu parte emocional con las heridas y las necesidades no cubiertas de la infancia.',
            '🧸'
        );
    }

    function executeDetectorAction(actionName) {
        closeGenModal(); // Cerrar el modal del detector primero

        // Usar un timeout para evitar que los modales colisionen
        setTimeout(() => {
            if (actionName === 'openJournal') {
                openJournalModal();
            } else if (actionName === 'openOrganizer') {
                openOrganizerModal();
            }
        // Nueva acción para abrir la respiración
        else if (actionName === 'openBreathing') {
            openBreathingModal();
        }
        // No hacer nada para otras acciones como 'close'
        }, 300); // 300ms de retraso para una transición suave
    }

async function openDetectorModal() {
    const now = Date.now();
    const seconds = Math.floor((now - sessionStartTime) / 1000);
    
    // Formato de tiempo
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    const timeString = `${String(min).padStart(2, '0')}m ${String(sec).padStart(2, '0')}s`;

    // Métricas de comportamiento
    const cpm = sessionClickCount / (seconds / 60 || 1); // Clicks por minuto
    const scrollMeters = (sessionScrollAmount / 3780).toFixed(1); // 3780px ~ 1 metro en una pantalla típica
    const scrollIntensity = sessionScrollAmount / (seconds || 1); // Pixels por segundo

    // Lógica de Estado Optimizada para móvil
    let estado = "ANALIZANDO...";
    let icono = "🤔";
    let mensaje = "";
    let accion = "";
    let actionName = "";
    let color = "var(--text-secondary)";
    
    if (seconds < 15) {
         estado = "CALIBRANDO";
         icono = "📡";
         mensaje = "Acabas de llegar. El sistema está midiendo tu ritmo base. Respira.";
         accion = "Continuar Explorando";
         actionName = "close";
         color = "var(--neon-blue)";
    } else if (cpm > 35 || scrollIntensity > 1800) {
         estado = "SOBRECARGA DIGITAL";
         icono = "⚡";
         mensaje = "Tu interacción es muy rápida. Estás buscando estímulos constantes. Es un signo de ansiedad.";
         accion = "Pausa de 1 Minuto (Respira)";
         actionName = "openBreathing";
         color = "#f44336";
    } else if (seconds > 120 && scrollIntensity > 600 && cpm < 10) {
         estado = "DOOMSCROLLING";
         icono = "🌪️";
         mensaje = "Llevas tiempo deslizando sin parar. Estás consumiendo contenido pasivamente, lo que puede agotar tu energía mental.";
         accion = "Escribir un Pensamiento Ahora";
         actionName = "openJournal";
         color = "#ff9800";
    } else if (seconds > 240 && cpm < 5 && scrollIntensity < 100) {
         estado = "RUMIACIÓN / ESTASIS";
         icono = "💭";
         mensaje = "Tu actividad es muy baja. Es posible que te hayas quedado 'atrapado' en un bucle de pensamientos.";
         accion = "Mover el Cuerpo (Estírate)";
         actionName = "close";
         color = "#9e9e9e";
    } else {
         estado = "ENFOQUE CONSCIENTE";
         icono = "🧘";
         mensaje = "Tu ritmo de interacción es equilibrado. Estás presente y navegando con intención.";
         accion = "Revisar Metas y Hábitos";
         actionName = "openOrganizer";
         color = "#4caf50";
    }

    // --- Guardar en Supabase si hay usuario ---
    if (estado !== "CALIBRANDO") {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            try {
                const { error } = await supabaseClient
                    .from('detector_resultados') // Asegúrate de que esta tabla exista
                    .insert([{ 
                        user_id: user.id,
                        estado: estado,
                        duracion_sesion: seconds,
                        clicks_sesion: sessionClickCount,
                        scroll_sesion: Math.round(sessionScrollAmount),
                        cpm: cpm,
                        scroll_intensidad: scrollIntensity
                    }]);
                if (error) throw error;
            } catch (error) { console.error("Error al guardar resultado del detector:", error.message); }
        }
    }
    
    const actionButtonHtml = `<button class="btn" onclick="executeDetectorAction('${actionName}')" style="width:100%; background: ${color}; color: white; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <div style="font-size: 0.8em; opacity: 0.9; margin-bottom: 5px;">ACCIÓN RECOMENDADA</div>
        <div style="font-size: 1.2em; font-weight: bold;">${accion}</div>
    </button>`;

    const content = `
        <div style="text-align: center;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0 20px 0; background: var(--surface-hover); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                <div><div style="font-size: 1.4em; font-weight: bold; color: var(--text-primary);">${sessionClickCount}</div><div style="font-size: 0.6em; font-weight:bold; color: var(--text-secondary);">TAPS</div></div>
                <div><div style="font-size: 1.4em; font-weight: bold; color: var(--text-primary);">${timeString}</div><div style="font-size: 0.6em; font-weight:bold; color: var(--text-secondary);">TIEMPO</div></div>
                <div><div style="font-size: 1.4em; font-weight: bold; color: var(--text-primary);">${scrollMeters}m</div><div style="font-size: 0.6em; font-weight:bold; color: var(--text-secondary);">SCROLL</div></div>
            </div>
            <div style="border: 3px solid ${color}; padding: 20px; border-radius: 15px; margin-bottom: 20px; background: var(--bg-app);">
                <div style="font-size: 2.5em; margin-bottom: 10px;">${icono}</div>
                <div style="font-size: 0.8em; letter-spacing: 2px; margin-bottom: 5px; color: var(--text-secondary); font-weight:bold;">ESTADO DETECTADO</div>
                <div style="font-size: 1.3em; font-weight: bold; color: ${color}; text-transform: uppercase; margin-bottom: 10px;">${estado}</div>
                <p style="color: var(--text-primary); font-style: italic; margin-bottom: 0; font-size: 0.9em;">"${mensaje}"</p>
            </div>
            ${actionButtonHtml}
        </div>
    `;
    openModal("Detector de Impulsos (Paso 10)", content);
}

    // --- RESPIRACIÓN CÓSMICA (MEJORADA) ---
    const BREATHING_PATTERNS = {
        coherence: { name: 'Coherencia Cardíaca (5-5)', steps: [{ state: 'INHALA', duration: 5000 }, { state: 'EXHALA', duration: 5000 }] },
        box: { name: 'Respiración de Caja (4-4-4-4)', steps: [{ state: 'INHALA', duration: 4000 }, { state: 'SOSTÉN', duration: 4000 }, { state: 'EXHALA', duration: 4000 }, { state: 'SOSTÉN', duration: 4000 }] },
        relax: { name: 'Técnica Relajante (4-7-8)', steps: [{ state: 'INHALA', duration: 4000 }, { state: 'SOSTÉN', duration: 7000 }, { state: 'EXHALA', duration: 8000 }] }
    };
    let breathTimeout = null;

    function openBreathingModal() {
        const optionsHtml = Object.keys(BREATHING_PATTERNS).map(key => 
            `<option value="${key}">${BREATHING_PATTERNS[key].name}</option>`
        ).join('');

        const content = `
            <div style="text-align: center;">
                <h3 style="color: var(--neon-blue);">Respiración Cósmica</h3>
                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
                    Sigue el ritmo de la luz para regular tu sistema nervioso.
                </p>
                
                <select id="breath-pattern-select" onchange="resetBreathing()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; color: var(--text-primary); background: var(--bg-app); font-size: 1em;">
                    ${optionsHtml}
                </select>

                <div id="breath-container">
                    <div id="breath-circle"></div>
                    <div id="breath-text">LISTO</div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="startBreathing()"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> INICIAR</button>
                    <button class="btn" style="background: #444;" onclick="stopBreathing()"><svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg> DETENER</button>
                </div>
            </div>
        `;
        openModal("🌬️ Respiración Guiada", content);
    }

    function startBreathing() {
        const circle = document.getElementById('breath-circle');
        const text = document.getElementById('breath-text');
        const patternKey = document.getElementById('breath-pattern-select').value;
        const pattern = BREATHING_PATTERNS[patternKey];
        if(!circle || !pattern) return;

        stopBreathing(); // Limpiar ciclo anterior

        let stepIndex = 0;

        const cycle = () => {
            const step = pattern.steps[stepIndex];
            const durationSec = step.duration / 1000;
            
            text.innerText = step.state;
            circle.style.transition = `transform ${durationSec}s ease-in-out, opacity ${durationSec}s ease-in-out`;

            if (step.state === 'INHALA') {
                circle.style.transform = "scale(3.5)";
                circle.style.opacity = "1";
            } else if (step.state === 'EXHALA') {
                circle.style.transform = "scale(1)";
                circle.style.opacity = "0.6";
            }
            // Para 'SOSTÉN', el estado visual no cambia, solo se espera.

            breathTimeout = setTimeout(() => {
                stepIndex = (stepIndex + 1) % pattern.steps.length;
                cycle();
            }, step.duration);
        };

        cycle();
    }

    function stopBreathing() {
        if (breathTimeout) {
            clearTimeout(breathTimeout);
            breathTimeout = null;
        }
        const circle = document.getElementById('breath-circle');
        const text = document.getElementById('breath-text');
        if(circle) {
            circle.style.transition = "none";
            circle.style.transform = "scale(1)";
            circle.style.opacity = "0.6";
            setTimeout(() => { circle.style.transition = ""; }, 50);
        }
        if(text) text.innerText = "LISTO";
    }

    function resetBreathing() {
        stopBreathing();
    }
      
    // --- LÓGICA NEBULOSA DE VOZ ---
    let nebulaContext, nebulaAnalyser, nebulaDataArray, nebulaSource, nebulaStream;
    let nebulaParticles = [];
    let nebulaAnimationId;

    function openNebulaMode() {
        document.getElementById('nebula-overlay').style.display = 'flex';
        document.getElementById('nebula-start-btn').style.display = 'block';
        document.getElementById('nebula-ui').style.opacity = 1;
        
        const canvas = document.getElementById('nebula-canvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function startNebula() {
        document.getElementById('nebula-start-btn').style.display = 'none';
        
        nebulaContext = new (window.AudioContext || window.webkitAudioContext)();
        nebulaAnalyser = nebulaContext.createAnalyser();
        
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            nebulaStream = stream;
            nebulaSource = nebulaContext.createMediaStreamSource(stream);
            nebulaSource.connect(nebulaAnalyser);
            nebulaAnalyser.fftSize = 256;
            nebulaDataArray = new Uint8Array(nebulaAnalyser.frequencyBinCount);
            animateNebula();
        }).catch(err => {
            alert("Se requiere permiso de micrófono para esta experiencia.");
            console.error(err);
        });
    }

    function stopNebula() {
        if (nebulaStream) {
            nebulaStream.getTracks().forEach(track => track.stop());
        }
        if (nebulaContext) {
            nebulaContext.close();
        }
        cancelAnimationFrame(nebulaAnimationId);
        document.getElementById('nebula-overlay').style.display = 'none';
    }

    class NebulaParticle {
        constructor(vol, w, h) {
            this.x = w / 2;
            this.y = h / 2;
            this.size = Math.random() * vol * 0.5 + 2;
            this.speedX = (Math.random() - 0.5) * (vol * 0.2);
            this.speedY = (Math.random() - 0.5) * (vol * 0.2);
            this.color = `hsla(${200 + vol}, 80%, 60%, ${vol/255})`;
            this.life = 100;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.life -= 1;
        }
        draw(ctx) {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function animateNebula() {
        const canvas = document.getElementById('nebula-canvas');
        if (!canvas) return; // Salir si el canvas no existe
        const ctx = canvas.getContext('2d');
        
        nebulaAnalyser.getByteFrequencyData(nebulaDataArray);
        let volume = nebulaDataArray.reduce((a, b) => a + b) / nebulaDataArray.length;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (volume > 10) {
            document.getElementById('nebula-ui').style.opacity = 0;
            for (let i = 0; i < 5; i++) {
                nebulaParticles.push(new NebulaParticle(volume, canvas.width, canvas.height));
            }
        } else {
            document.getElementById('nebula-ui').style.opacity = 0.5;
        }

        nebulaParticles = nebulaParticles.filter(p => p.life > 0);
        nebulaParticles.forEach(p => {
            p.update();
            p.draw(ctx);
        });

        nebulaAnimationId = requestAnimationFrame(animateNebula);
    }

    // --- LÓGICA PUPILA DIMENSIONAL ---
    let portalStream = null;
    let pupilMode = 'normal';
    let pupilRafId = null;
    let whisperInterval = null;
    const WHISPERS = ["Vales la pena", "Perdónate", "Estás a salvo", "Eres suficiente", "Respira", "Siente", "Aquí y ahora", "Amor propio", "Libertad", "Paz"];

    function openPupilaModal() {
        const overlay = document.getElementById('pupila-dimensional-overlay');
        if (overlay) {
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex'; // Asegurarse de que sea visible
        }
    }

    async function activatePortal() {
        const portal = document.getElementById('portal');
        const video = document.getElementById('vision-stream');
        const text = document.getElementById('inner-child-text');
        const canvas = document.getElementById('pupil-canvas');
        
        if (portal.classList.contains('expanded')) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", frameRate: { ideal: 30 } } 
            });
            portalStream = stream;
            video.srcObject = stream;
            
            portal.classList.add('expanded');
            
            setTimeout(() => {
                text.style.transition = "opacity 2s ease";
                text.style.opacity = "1";
                portal.style.boxShadow = "inset 0 0 200px rgba(255,255,255,0.5)";
            }, 1500);
            
            // Iniciar loop de efectos
            startPupilLoop();

        } catch (err) {
            console.error("Acceso denegado a la cámara", err);
            alert("Se necesita acceso a la cámara para esta experiencia.");
            deactivatePortal(); // Cerrar si hay error
        }
    }

    function setPupilMode(mode, event) {
        if(event) event.stopPropagation();
        pupilMode = mode;
        
        // Actualizar UI botones
        document.querySelectorAll('.pupil-btn').forEach(btn => btn.classList.remove('active'));
        if(event && event.target) event.target.classList.add('active');

        const video = document.getElementById('vision-stream');
        const canvas = document.getElementById('pupil-canvas');
        
        // Reset visuales
        video.style.filter = "saturate(1.2) contrast(1.1) brightness(1.1)";
        canvas.style.opacity = (mode === 'echo') ? "1" : "0";

        if (mode === 'aura') {
            video.style.filter = "hue-rotate(90deg) contrast(1.5) saturate(2)";
        }
    }

    function startPupilLoop() {
        const video = document.getElementById('vision-stream');
        const canvas = document.getElementById('pupil-canvas');
        const ctx = canvas.getContext('2d');
        
        // Ajustar canvas al tamaño de ventana
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Iniciar susurros
        if (whisperInterval) clearInterval(whisperInterval);
        whisperInterval = setInterval(spawnWhisper, 3000);

        function loop() {
            if (!portalStream) return;

            if (pupilMode === 'echo') {
                // Efecto ECO: Dibujar frame actual con baja opacidad sobre el anterior
                // Esto crea el rastro de movimiento
                ctx.save();
                ctx.globalAlpha = 0.15; // La magia del rastro
                
                // Espejo horizontal para coincidir con el video CSS
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                
                // Dibujar video escalado para llenar pantalla (object-fit: cover simulado)
                // Simplificación: dibujar estirado o centrado
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            } else if (pupilMode === 'normal' || pupilMode === 'aura') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            pupilRafId = requestAnimationFrame(loop);
        }
        loop();
    }

    function spawnWhisper() {
        const portal = document.getElementById('portal');
        if (!portal.classList.contains('expanded')) return;

        const word = WHISPERS[Math.floor(Math.random() * WHISPERS.length)];
        const el = document.createElement('div');
        el.className = 'whisper-word';
        el.innerText = word;
        
        // Posición aleatoria alrededor del centro
        const x = (Math.random() * 60) + 20; // 20% a 80%
        const y = (Math.random() * 60) + 20;
        
        el.style.left = x + '%';
        el.style.top = y + '%';
        
        portal.appendChild(el);
        
        // Limpieza automática por animación CSS, pero removemos del DOM por seguridad
        setTimeout(() => el.remove(), 5000);
    }

    function deactivatePortal() {
        const portal = document.getElementById('portal');
        const overlay = document.getElementById('pupila-dimensional-overlay');
        const text = document.getElementById('inner-child-text');
        const pupil = document.getElementById('inner-pupil');

        if (portal) portal.classList.remove('expanded');
        if (overlay) {
             overlay.classList.add('hidden');
             overlay.style.display = 'none';
        }
        if (text) text.style.opacity = "0";
        if (pupil) pupil.style.transform = 'translate(0px, 0px)';
        if (portal) portal.style.boxShadow = "0 0 100px rgba(58, 123, 213, 0.4)";

        // Detener loops
        if (pupilRafId) cancelAnimationFrame(pupilRafId);
        if (whisperInterval) clearInterval(whisperInterval);
        // Limpiar susurros
        document.querySelectorAll('.whisper-word').forEach(el => el.remove());

        if (portalStream) {
            portalStream.getTracks().forEach(track => track.stop());
            portalStream = null;
        }
    }
    
    // Mover la pupila con el ratón/dedo
    document.addEventListener('mousemove', (e) => {
        const portal = document.getElementById('portal');
        const pupil = document.getElementById('inner-pupil');
        if(portal && pupil && !portal.classList.contains('expanded')) {
            const rect = portal.getBoundingClientRect();
            const x = (e.clientX - rect.left - rect.width/2) / 10;
            const y = (e.clientY - rect.top - rect.height/2) / 10;
            pupil.style.transform = `translate(${x}px, ${y}px)`;
        }
    });

    function openAnimatedModal(title, points, concept, mainIcon) {
        let bodyHtml = '';
        let isInnerChild = (mainIcon === '🧸'); 
          
        if (concept) {
            bodyHtml += `
                <div class="concept-header">
                    ${mainIcon} CONCEPTO: ${concept}
                </div>
            `;
            bodyHtml += '<h3 style="color: var(--text-primary); font-size: 1.1em; margin-top: 15px;">PASOS DE LA TAREA:</h3>';
        }

        bodyHtml += '<div class="task-list">';
        points.forEach((item, index) => {
            // Asegurarse de que el formato **negrita** funcione
            const formattedText = item.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            bodyHtml += `
                <div class="task-item-container">
                    <div class="task-circle">${item.icon}</div>
                    <div class="task-text">${formattedText}</div>
                </div>
            `;
        });
        bodyHtml += '</div>';

        if (isInnerChild) {
            const tempEntry = loadTempEntry(INNER_CHILD_KEY);
            const historyLines = loadJournalHistory(INNER_CHILD_KEY);
            const historyHtml = generateHistoryHtml(historyLines);

            bodyHtml += `
                <div style="margin: 20px 0; padding: 15px; border: 1px solid var(--neon-blue); border-radius: 10px; background: rgba(0,0,0,0.2);">
                    <h4 style="color: var(--neon-blue); margin-top:0;">🌌 Exhalando el Dolor</h4>
                    <p style="font-size: 0.9em; color: var(--text-primary);">Una experiencia interactiva para liberar emociones con tu voz.</p>
                    <button class="btn" onclick="openNebulaMode()">🎙️ Iniciar Experiencia</button>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; border: 1px solid var(--neon-purple); border-radius: 10px; background: rgba(0,0,0,0.2);">
                    <h4 style="color: var(--neon-purple); margin-top:0;">🔮 Santuario Visual</h4>
                    <p style="font-size: 0.9em; color: var(--text-primary);">Visualiza la reacción de tu niño interior ante la dureza.</p>
                    <button class="btn" onclick="openInnerChildOrbModal()" style="background: var(--neon-purple);">Abrir Santuario</button>
                </div>

                <div style="margin: 20px 0; padding: 15px; border: 1px solid #ff9800; border-radius: 10px; background: rgba(0,0,0,0.2);">
                    <h4 style="color: #ff9800; margin-top:0;">🤯 Vaciado de Cerebro</h4>
                    <p style="font-size: 0.9em; color: var(--text-primary);">Libera el ruido mental escribiendo sin filtros.</p>
                    <button class="btn" onclick="openBrainDumpModal()" style="background: #ff9800;">Iniciar Vaciado</button>
                </div>

                <hr style="margin: 30px auto; border: 0; border-top: 1px dashed var(--neon-blue);">
                <h3 style="color: var(--neon-blue); font-size: 1.1em; margin-top: 15px;">
                    ✍️ Promesas y Necesidades del Niño (Registro)
                </h3>
                <p style="font-size: 0.85em; color: var(--text-primary); opacity: 0.8; margin-bottom: 10px;">
                    Escribe aquí qué promesas le hiciste o qué necesidades identificaste que debes cubrir.
                </p>
                <textarea id="inner-child-textarea" 
                          placeholder="Hoy mi niño me pidió más límites (o más afecto). Le prometo..."
                          oninput="saveTempEntry(INNER_CHILD_KEY, 'inner-child-textarea')">${tempEntry}</textarea>

                <button class="btn" style="background: var(--color-secondary); margin-top: 10px;"
                    onclick="saveNewEntry(INNER_CHILD_KEY, 'inner-child-textarea', 'Niño Interior')">
                    💾 GUARDAR NUEVO REGISTRO
                </button>
                <p style="font-size: 0.75em; color: var(--text-secondary); opacity: 0.7; margin-top: 5px; text-align: right;">
                    La entrada actual se guarda automáticamente como borrador.
                </p>

                <div class="history-container">
                    <h4>Historial de Promesas (${historyLines.length})</h4>
                    ${historyHtml}
                </div>
            `;
        }

        openModal(title, bodyHtml);
    }
    
    // --- NUEVA MOCHILA EMOCIONAL (ALQUIMIA MEJORADA) ---
    function openMochilaModal() {
        const content = `
            <div id="mochila-container" class="mochila-container">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M20 8h-3V6.21c0-2.61-1.91-4.94-4.51-5.19C9.51.74 7 3.08 7 6v2H4v14h16V8zm-8-2c1.1 0 2 .9 2 2v2h-4V6c0-1.1.9-2 2-2zm0 12c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>
                    <h2 style="color: var(--neon-blue); margin: 0;">Mochila Emocional</h2>
                </div>
                
                <!-- Paso 0: Menú Principal -->
                <div id="mochila-step-0" class="mochila-step active">
                    <p>Tu mochila contiene pesos, pero también el potencial de transformarlos en tesoros. ¿Qué quieres hacer?</p>
                    <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                        <button class="btn" onclick="mochila_showStep('mochila-step-1')">➕ Añadir un Peso</button>
                        <button class="btn" style="background: var(--color-secondary);" onclick="mochila_showTreasure()">💎 Ver mi Tesoro</button>
                    </div>
                </div>

                <!-- Paso 1: Elegir Categoría -->
                <div id="mochila-step-1" class="mochila-step">
                    <h4>1. Identifica el tipo de peso</h4>
                    <div class="mochila-categories">
                        <div class="category-btn" onclick="mochila_selectCategory('miedo')"><span class="icon"><svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:var(--text-primary);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></span><span class="text">Miedo</span></div>
                        <div class="category-btn" onclick="mochila_selectCategory('culpa')"><span class="icon"><svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:var(--text-primary);"><path d="M10 15h4v2h-4v-2zm0-4h4v2h-4v-2zm0-4h4v2h-4V7zM6 3h12v18H6V3z"/></svg></span><span class="text">Culpa</span></div>
                        <div class="category-btn" onclick="mochila_selectCategory('rencor')"><span class="icon"><svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:var(--text-primary);"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg></span><span class="text">Rencor</span></div>
                        <div class="category-btn" onclick="mochila_selectCategory('tristeza')"><span class="icon"><svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:var(--text-primary);"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg></span><span class="text">Tristeza</span></div>
                    </div>
                    <button class="btn" style="background: #555;" onclick="mochila_showStep('mochila-step-0')">Volver</button>
                </div>

                <!-- Paso 2: Describir y Transmutar -->
                <div id="mochila-step-2" class="mochila-step">
                    <h4 id="mochila-title-2"></h4>
                    <p>Describe la situación o sentimiento específico:</p>
                    <textarea id="mochila-input-peso" class="mochila-textarea" placeholder="Ej: Siento miedo de hablar en público..."></textarea>
                    
                    <p id="mochila-question"></p>
                    <textarea id="mochila-input-gema" class="mochila-textarea" placeholder="..."></textarea>
                    
                    <button id="mochila-alchemy-btn" class="btn" onclick="mochila_performAlchemy()">✨ Transmutar en Gema</button>
                    <button class="btn" style="background: #555; margin-left:10px;" onclick="mochila_showStep('mochila-step-1')">Cancelar</button>
                </div>

                <!-- Paso 3: Ver Tesoro -->
                <div id="mochila-step-3" class="mochila-step">
                    <h4>💎 Tu Tesoro de Sabiduría</h4>
                    <div id="gem-collection" class="gem-collection"></div>
                    <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                        <button class="btn" style="background: var(--color-alert);" onclick="mochila_clearGems()">🗑️ Vaciar Mochila</button>
                        <button class="btn" style="background: #555;" onclick="mochila_showStep('mochila-step-0')">Volver al Inicio</button>
                    </div>
                </div>
            </div>
        `;
        openModal("🎒 Mochila Alquimia", content);
    }

    function mochila_showStep(stepId) {
        document.querySelectorAll('.mochila-step').forEach(step => step.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');
    }

    function mochila_selectCategory(category) {
        currentMochilaCategory = category;
        const guide = ALCHEMY_GUIDE[category];
        
        document.getElementById('mochila-title-2').innerText = `2. Alquimia de(l) ${guide.title}`;
        document.getElementById('mochila-question').innerText = guide.question;
        document.getElementById('mochila-input-gema').placeholder = guide.placeholder;
        
        mochila_showStep('mochila-step-2');
    }

    function mochila_performAlchemy() {
        const peso = document.getElementById('mochila-input-peso').value.trim();
        const gemaTexto = document.getElementById('mochila-input-gema').value.trim();

        if (!peso || !gemaTexto) {
            alert("Debes completar ambos campos para la transmutación.");
            return;
        }

        const guide = ALCHEMY_GUIDE[currentMochilaCategory];
        const newGem = {
            type: guide.gem_type,
            color: guide.gem_color,
            wisdom: gemaTexto,
            origin: `Transformado de: ${guide.title} - "${peso}"`
        };

        const savedGems = JSON.parse(localStorage.getItem(MOCHILA_KEY) || '[]');
        savedGems.push(newGem);
        localStorage.setItem(MOCHILA_KEY, JSON.stringify(savedGems));

        alert(`¡Alquimia completada! Has forjado una ${guide.gem_type}.`);
        
        document.getElementById('mochila-input-peso').value = '';
        document.getElementById('mochila-input-gema').value = '';
        mochila_showTreasure();
    }

    function mochila_showTreasure() {
        const savedGems = JSON.parse(localStorage.getItem(MOCHILA_KEY) || '[]');
        const collectionDiv = document.getElementById('gem-collection');
        
        if (savedGems.length === 0) {
            collectionDiv.innerHTML = '<p style="opacity:0.7;">Tu tesoro está vacío. ¡Es hora de empezar la alquimia!</p>';
        } else {
            const groupedGems = savedGems.reduce((acc, gem) => {
                (acc[gem.type] = acc[gem.type] || []).push(gem);
                return acc;
            }, {});

            let html = '';
            for (const type in groupedGems) {
                const guideEntry = Object.values(ALCHEMY_GUIDE).find(g => g.gem_type === type);
                const color = guideEntry ? guideEntry.gem_color : '#ccc';

                html += `<div class="gem-category">
                            <h4 style="color: ${color} !important; border-bottom-color: ${color};">${type} (${groupedGems[type].length})</h4>`;
                
                groupedGems[type].slice().reverse().forEach(gem => { // .slice().reverse() to show newest first
                    html += `<div class="gem-item" style="border-left-color: ${color};">
                                <span class="wisdom">${gem.wisdom}</span>
                                <span class="origin">${gem.origin}</span>
                             </div>`;
                });
                html += `</div>`;
            }
            collectionDiv.innerHTML = html;
        }
        
        mochila_showStep('mochila-step-3');
    }

    function mochila_clearGems() {
        if (confirm("¿Estás seguro de que quieres vaciar tu mochila? Todas tus gemas de sabiduría se perderán. Esta acción simboliza un nuevo comienzo.")) {
            localStorage.removeItem(MOCHILA_KEY);
            mochila_showTreasure();
            alert("Mochila vaciada. Un nuevo espacio para nuevos tesoros.");
        }
    }

    // --- FUNCIÓN DE MÚSICA Y VOLUMEN ---
    function openMusicModal() {
        const audio = document.getElementById('bg-music');
        // Volumen por defecto al 50% si no está definido
        if (audio && !audio.volume) audio.volume = 0.5;
        
        const isPlaying = audio && !audio.paused;
        const currentVol = audio ? Math.round(audio.volume * 100) : 50;

        // Lista de canciones con los nombres solicitados
        const songs = [
            { name: "Reflexion 1", url: "audio/relax.mp3" },
            { name: "Reflexion 2", url: "audio/rain.mp3" },
            { name: "Reflexion 3", url: "audio/piano.mp3" }
        ];

        // Generar opciones del selector
        const currentSrc = audio.src || (audio.querySelector('source') ? audio.querySelector('source').src : '');
        
        let optionsHtml = '';
        songs.forEach(song => {
            const selected = currentSrc.includes(song.url) ? 'selected' : '';
            optionsHtml += `<option value="${song.url}" ${selected}>${song.name}</option>`;
        });

        const content = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <h2 style="color: var(--neon-blue); margin: 0;">Zona de Relax</h2>
            </div>
            <p style="color: var(--text-primary); margin-bottom: 25px;">
                Elige tu ambiente y ajusta el volumen.
            </p>

            <div style="background: var(--surface-hover); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);">
                
                <label style="display:block; text-align:left; font-weight:bold; color:var(--text-primary); margin-bottom:5px;">Canción:</label>
                <select id="song-select" onchange="changeSong(this.value)" 
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; color: var(--text-primary); background: var(--bg-app); font-size: 1em;">
                    ${optionsHtml}
                </select>

                <button id="music-toggle-btn" class="btn" onclick="toggleMusicFromModal()" 
                        style="width: 100%; max-width: 200px; margin-bottom: 25px; font-size: 1.1em;">
                    ${isPlaying ? '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> PAUSAR' : '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> REPRODUCIR'}
                </button>

                <div style="margin: 0 auto; max-width: 250px; text-align: left;">
                    <label for="music-volume" style="display: flex; justify-content: space-between; color: var(--text-primary); margin-bottom: 10px; font-weight: bold;">
                        <span>🔊 Volumen</span>
                        <span id="vol-display" style="color: var(--neon-blue);">${currentVol}%</span>
                    </label>
                    <input type="range" id="music-volume" min="0" max="100" value="${currentVol}" 
                           oninput="changeVolume(this.value)" 
                           style="width: 100%; cursor: pointer; accent-color: var(--neon-blue);">
                </div>
            </div>
            
            <p style="margin-top: 15px; font-weight: bold; color: var(--neon-blue); font-size: 0.9em;">
                CRÉDITOS: MANUEL SALMUN
            </p>
            
            <p style="font-size: 0.8em; color: var(--text-secondary); opacity: 0.7; margin-top: 20px;">
                *Asegúrate de tener los archivos mp3 en la carpeta 'audio'.
            </p>
        `;
        openModal("🎵 Reproductor", content);
    }

    function changeSong(url) {
        const audio = document.getElementById('bg-music');
        const btn = document.getElementById('music-toggle-btn');
        if(!audio) return;

        const wasPlaying = !audio.paused;

        // Cambiar la fuente del audio
        audio.src = url;
        audio.load(); 

        // Si estaba sonando, reproducir la nueva automáticamente
        if (wasPlaying) {
            audio.play().catch(e => alert("No se encontró el archivo: " + url));
            if(btn) btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> PAUSAR';
        } else {
            if(btn) btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> REPRODUCIR';
        }
    }

    function toggleMusicFromModal() {
        const audio = document.getElementById('bg-music');
        const btn = document.getElementById('music-toggle-btn');
        if (!audio) return;

        if (audio.paused) {
            audio.play().catch(e => alert("No se encontró el audio. Asegúrate de tener la carpeta 'audio' con 'relax.mp3'."));
            if(btn) btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> PAUSAR';
        } else {
            audio.pause();
            if(btn) btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> REPRODUCIR';
        }
    }

    function changeVolume(val) {
        const audio = document.getElementById('bg-music');
        const display = document.getElementById('vol-display');
        if (audio) {
            audio.volume = val / 100;
        }
        if (display) {
            display.innerText = val + '%';
        }
    }

    // --- FUNCIÓN DE GESTIÓN DE DATOS (BACKUP) ---
    function openDataModal() {
        const content = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zM15 9H5V5h10v4z"/></svg>
                <h2 style="color: var(--neon-blue); margin: 0;">Gestión de Datos</h2>
            </div>
            <p style="color: var(--text-primary); margin-bottom: 20px;">
                Tus datos se guardan solo en este dispositivo. <br>
                <strong>¡Haz copias de seguridad frecuentemente!</strong>
            </p>

            <div style="border: 1px dashed var(--neon-blue); padding: 15px; border-radius: 10px; margin-bottom: 20px; background: var(--surface-hover);">
                <h4 style="color: var(--neon-blue); margin-top: 0;">📤 Exportar (Guardar)</h4>
                <p style="font-size: 0.85em; color: var(--text-primary);">Descarga un archivo con tu diario, fechas y configuraciones.</p>
                <button class="btn" onclick="exportData()"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> DESCARGAR RESPALDO</button>
            </div>

            <div style="border: 1px dashed var(--color-secondary); padding: 15px; border-radius: 10px; background: var(--surface-hover);">
                <h4 style="color: var(--color-secondary); margin-top: 0;">📥 Importar (Restaurar)</h4>
                <p style="font-size: 0.85em; color: var(--text-primary);">Recupera tus datos desde un archivo de respaldo.</p>
                <input type="file" id="backup-file" accept=".json" style="margin-top: 10px; color: var(--text-primary);">
                <button class="btn" style="background: var(--color-secondary); margin-top: 10px;" onclick="importData()"><svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg> RESTAURAR DATOS</button>
            </div>
        `;
        openModal("💾 Mis Datos", content);
    }

    function exportData() {
        const data = JSON.stringify(localStorage);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().slice(0,10);
        a.href = url;
        a.download = `oddoner_backup_${date}.json`;
        a.click();
    }

    function importData() {
        const input = document.getElementById('backup-file');
        if (!input || !input.files[0]) {
            alert("Por favor selecciona un archivo .json primero.");
            return;
        }
        const file = input.files[0];
        reader.onload = function(e) {
            if(confirm("⚠️ ADVERTENCIA: Esto reemplazará todos los datos actuales con los del archivo. ¿Estás seguro?")) {
                const data = JSON.parse(e.target.result);
                localStorage.clear();
                for (let key in data) {
                    localStorage.setItem(key, data[key]);
                }
                alert("✅ Datos restaurados correctamente. La aplicación se reiniciará.");
                location.reload();
            }
        };
        reader.readAsText(file);
    }

    // --- NUEVO ORGANIZADOR ---
    let tareas = JSON.parse(localStorage.getItem("tareas")) || [];
    let metas = JSON.parse(localStorage.getItem("metas")) || [];
    let habitos = JSON.parse(localStorage.getItem("habitos")) || [];

    /* ---------- TAREAS ---------- */
    function agregarTarea() {
        const tareaTexto = document.getElementById("tareaTexto");
        const tareaFecha = document.getElementById("tareaFecha");
        let texto = tareaTexto.value;
        let fecha = tareaFecha.value;
        if (!texto) return;

        tareas.push({ texto, fecha, hecho: false });
        guardar();
        mostrarTareas();
        tareaTexto.value = "";
    }

    function mostrarTareas() {
        const tareasUl = document.getElementById("tareas");
        if (!tareasUl) return;
        tareasUl.innerHTML = "";
        tareas.forEach((t, i) => {
            let li = document.createElement("li");
            li.innerHTML = `
            <span onclick="toggleTarea(${i})" style="cursor: pointer;" class="${t.hecho ? 'completado' : ''}">
            ${t.texto} ${t.fecha ? `<span style="font-size:0.8em; opacity:0.7;">📅 ${t.fecha}</span>` : ""}
            </span>
            <button onclick="eliminarTarea(${i})">❌</button>`;
            tareasUl.appendChild(li);
        });
    }

    function toggleTarea(i) {
        tareas[i].hecho = !tareas[i].hecho;
        guardar();
        mostrarTareas();
    }

    function eliminarTarea(i) {
        if (!confirm("¿Eliminar esta tarea?")) return;
        tareas.splice(i, 1);
        guardar();
        mostrarTareas();
    }

    /* ---------- METAS ---------- */
    function agregarMeta() {
        const metaTexto = document.getElementById("metaTexto");
        let texto = metaTexto.value;
        if (!texto) return;

        metas.push({ texto, progreso: 0, isPillar: false });
        guardar();
        mostrarMetas();
        metaTexto.value = "";
    }

    function mostrarMetas() {
        const metasUl = document.getElementById("metas");
        if (!metasUl) return;
        metasUl.innerHTML = "";
        metas.forEach((m, i) => {
            let li = document.createElement("li");
            li.className = 'meta-item';
            li.innerHTML = `
            <div>
                <strong>${m.texto}</strong> (${m.progreso}%)
                <div class="barra">
                    <div class="progreso" style="width:${m.progreso}%"></div>
                </div>
                <button onclick="sumarMeta(${i})">➕</button>
                <button onclick="restarMeta(${i})">➖</button>
                <button onclick="eliminarMeta(${i})">❌</button>
            </div>`;
            metasUl.appendChild(li);
        });
    }

    function sumarMeta(i) {
        if (metas[i].progreso < 100) metas[i].progreso = Math.min(100, metas[i].progreso + 10);
        guardar();
        mostrarMetas();
    }
    
    function restarMeta(i) {
        if (metas[i].progreso > 0) metas[i].progreso = Math.max(0, metas[i].progreso - 10);
        guardar();
        mostrarMetas();
    }

    function eliminarMeta(i) {
        if (!confirm("¿Eliminar esta meta?")) return;
        metas.splice(i, 1);
        guardar();
        mostrarMetas();
    }

    /* ---------- HABITOS ---------- */
    function agregarHabito() {
        const habitoTexto = document.getElementById("habitoTexto");
        let texto = habitoTexto.value;
        if (!texto) return;

        habitos.push({ texto, contador: 0, isPillar: false });
        guardar();
        mostrarHabitos();
        habitoTexto.value = "";
    }

    function mostrarHabitos() {
        const habitosUl = document.getElementById("habitos");
        if (!habitosUl) return;
        habitosUl.innerHTML = "";
        habitos.forEach((h, i) => {
            let li = document.createElement("li");
            li.className = h.isPillar ? 'is-pillar' : '';
            li.innerHTML = `
            <div style="display: flex; align-items: center;">
                <span class="pillar-toggle" onclick="togglePillar(${i})">⭐</span>
                <span>${h.texto} <strong style="color:var(--neon-blue)">🔥 ${h.contador}</strong></span>
            </div>
            <div>
                <button onclick="sumarHabito(${i})">✔️</button>
                <button onclick="eliminarHabito(${i})">❌</button>
            </div>`;
            habitosUl.appendChild(li);
        });
    }

    function sumarHabito(i) {
        habitos[i].contador++;
        guardar();
        renderPillars();
        if (document.getElementById("habitos")) {
            mostrarHabitos();
        }
    }

    function eliminarHabito(i) {
        if (!confirm("¿Eliminar este hábito?")) return;
        habitos.splice(i, 1);
        guardar();
        renderPillars();
        if (document.getElementById("habitos")) {
            mostrarHabitos();
        }
    }

    function togglePillar(i) {
        const pillarsCount = habitos.filter(h => h.isPillar).length;
        
        // Si el hábito actual no es un pilar y ya hay 3, no permitir más.
        if (!habitos[i].isPillar && pillarsCount >= 3) {
            alert("Solo puedes tener 3 hábitos pilares a la vez. Desmarca uno para poder añadir este.");
            return;
        }

        habitos[i].isPillar = !habitos[i].isPillar;
        guardar();
        renderPillars();
        if (document.getElementById("habitos")) {
            mostrarHabitos();
        }
    }

    /* ---------- GUARDAR ---------- */
    function guardar() {
        localStorage.setItem("tareas", JSON.stringify(tareas));
        localStorage.setItem("metas", JSON.stringify(metas));
        localStorage.setItem("habitos", JSON.stringify(habitos));
    }
      
    // --- FUNCIONES DE BOTONES DE TIEMPO ---
      
    function showDatePicker() {
        const currentStartTime = localStorage.getItem(KEY);
        const dateObject = currentStartTime ? new Date(parseInt(currentStartTime)) : new Date();
        const year = dateObject.getFullYear();
        const month = String(dateObject.getMonth() + 1).padStart(2, '0');
        const day = String(dateObject.getDate()).padStart(2, '0');
        const hour = String(dateObject.getHours()).padStart(2, '0');
        const minute = String(dateObject.getMinutes()).padStart(2, '0');
        const dateValue = `${year}-${month}-${day}T${hour}:${minute}`;

        // CORRECCIÓN: Se arregló la sintaxis de la cadena HTML para incluir el input y el botón
        openModal("Configurar Fecha",
            `<input type='datetime-local' id='picker' value='${dateValue}' style='width:100%; padding:10px; margin-bottom:10px; background: var(--bg-app); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary); border-radius: 8px;'>
             <button class="btn" onclick="saveDate()">GUARDAR</button>`);
    }
      
    function saveDate() {
        const picker = document.getElementById('picker');
        if(!picker) return;

        const val = picker.value;
        if(val) {
            // Se usa Date.parse() para manejar mejor el formato datetime-local
            startTime = Date.parse(val); 
            if (!isNaN(startTime)) {
                localStorage.setItem(KEY, startTime);
                closeGenModal();
                updateClock(); 
            } else {
                 alert("Formato de fecha u hora no válido.");
            }
        }
    }
      
    function resetCounter() {
        if(confirm("¿Estás seguro de que quieres reiniciar tu tiempo de sobriedad?\n\nRecuerda: No es un día más, es un día menos.")) {
            startTime = new Date().getTime();
            localStorage.setItem(KEY, startTime);
            updateClock(); 
        }
    }

    // --- LÓGICA DE LOGIN (NUEVO) ---
    async function openLoginModal() {
        const { data: { user } } = await supabaseClient.auth.getUser();

        if (user) {
            const content = `
                <div style="text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                        <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        <h2 style="color: var(--neon-blue); margin: 0;">Mi Cuenta</h2>
                    </div>
                    <p style="color: var(--text-primary); margin-bottom: 10px;">Sesión iniciada como:</p>
                    <p style="color: var(--neon-blue); font-weight: bold; margin-bottom: 20px;">${user.email}</p>
                    
                    <button onclick="logout()" class="btn" style="width: 100%; background: var(--color-alert);">Cerrar Sesión</button>
                </div>
            `;
            openModal("🔐 Mi Cuenta", content);
        } else {
            const content = `
                <div style="text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                        <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--neon-blue);"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                        <h2 style="color: var(--neon-blue); margin: 0;">Cuenta Oddoner</h2>
                    </div>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Ingresa tu correo para entrar.</p>
                    
                    <input type="email" id="correoLogin" placeholder="tu@correo.com" required 
                        style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                    <input type="password" id="passwordLogin" placeholder="Contraseña" required 
                        style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                    
                    <button id="btnEntrar" onclick="login()" class="btn" style="width: 100%; margin-top: 0;">Entrar</button>
                    
                    <p style="margin-top: 20px; font-size: 14px;">
                        <a href="#" onclick="openRegisterModal(); return false;" style="color: var(--neon-blue); text-decoration: none;">¿No tienes cuenta? Regístrate</a>
                    </p>
                </div>
            `;
            openModal("🔐 Login", content);
        }
    }

    function openRegisterModal() {
        const content = `
            <div style="text-align: center;">
                <h2 style="color: var(--neon-blue); margin-bottom: 20px;">Crea tu cuenta</h2>
                <input type="text" id="nombre" placeholder="Nombre completo" style="width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                <input type="email" id="correo" placeholder="Correo electrónico" style="width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                <input type="password" id="pass" placeholder="Crea una contraseña" style="width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                <select id="genero" style="width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                </select>
                <input type="number" id="edad" placeholder="Edad" style="width: 100%; padding: 12px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; box-sizing: border-box; font-size: 16px; background: var(--bg-app); color: var(--text-primary);">
                
                <button onclick="registrar()" class="btn" style="width: 100%; margin-top: 15px;">Registrarse ahora</button>
                
                <div style="margin-top: 15px; font-size: 14px; color: var(--text-primary);">
                    ¿Ya tienes cuenta? <a href="#" onclick="openLoginModal(); return false;" style="color: var(--neon-blue); text-decoration: none;">Inicia sesión</a>
                </div>
            </div>
        `;
        openModal("📝 Registro", content);
    }

    async function registrar() {
        const nombre = document.getElementById('nombre').value;
        const email = document.getElementById('correo').value;
        const password = document.getElementById('pass').value;
        const genero = document.getElementById('genero').value;
        const edad = document.getElementById('edad').value;

        if(!nombre || !email || !password) return alert("Por favor completa los campos");

        try {
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { nombre, genero, edad }
                }
            });

            if (error) throw error;

            alert("¡Registro exitoso! Revisa tu correo para confirmar o inicia sesión.");
            openLoginModal();
        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    async function login() {
        const correoInput = document.getElementById('correoLogin').value;
        const passwordInput = document.getElementById('passwordLogin').value;
        const btn = document.getElementById('btnEntrar');

        if (!correoInput || !passwordInput) {
            alert("Por favor, completa correo y contraseña");
            return;
        }

        btn.innerText = "Verificando...";
        btn.disabled = true;

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: correoInput,
                password: passwordInput
            });

            if (error) throw error;

            if (data.user) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                if (data.user.user_metadata && data.user.user_metadata.nombre) {
                    localStorage.setItem('usuario_nombre', data.user.user_metadata.nombre);
                }
                alert("¡Bienvenido de nuevo, " + (data.user.user_metadata.nombre || "Usuario") + "!");
                openLoginModal(); // Refrescar modal para mostrar estado logueado
            }
        } catch (error) {
            console.error(error);
            alert("Error: " + error.message);
        } finally {
            if(btn) {
                btn.innerText = "Entrar";
                btn.disabled = false;
            }
        }
    }

    async function logout() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) alert(error.message);
        else {
            alert('Sesión cerrada');
            openLoginModal();
        }
    }

    // --- JUEGO COGNITIVO (NEURO-ENTRENAMIENTO) ---
    const CARDS_ICONS = ['🧠', '💎', '🛡️', '🌿', '⚓', '🕯️', '🗝️', '☀️', '🌙', '⭐', '🔥', '💧', '🎵', '📚', '🚀', '🎨', '🐱', '🐶'];
    const MEMORY_LEVELS = [
        { r: 2, c: 2 }, { r: 3, c: 2 }, { r: 4, c: 2 }, { r: 3, c: 4 },
        { r: 4, c: 3 }, { r: 4, c: 4 }, { r: 5, c: 4 }, { r: 4, c: 5 },
        { r: 6, c: 4 }, { r: 4, c: 6 }, { r: 5, c: 6 }, { r: 6, c: 5 },
        { r: 6, c: 6 }, { r: 6, c: 6 }, { r: 6, c: 6 }, { r: 6, c: 6 }
    ];

    let hasFlippedCard = false;
    let lockBoard = false;
    let firstCard, secondCard;
    let matchesFound = 0;
    let currentLevelIndex = 0;
    let gameTimerInterval;
    let timeLeft;
    let totalTime;

    // --- Funciones de Sincronización y Guardado (Supabase + LocalStorage) ---

    async function syncCognitiveGameProgress() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return; // No hay sesión, usar datos locales

        const { data, error } = await supabaseClient
            .from('juego_memoria')
            .select('unlocked_level, stars')
            .eq('user_id', user.id)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = "No rows found"
            console.error('Error al cargar progreso del juego:', error);
            return;
        }

        if (data) {
            // La nube es la fuente de verdad. Actualizamos el localStorage.
            localStorage.setItem('cognitive_game_level_v1', data.unlocked_level || 0);
            localStorage.setItem('cognitive_game_stars_v1', JSON.stringify(data.stars || {}));
        }
    }

    function getUnlockedLevel() { return parseInt(localStorage.getItem('cognitive_game_level_v1') || '0'); }
    function getLevelStars(levelIndex) {
        const stars = JSON.parse(localStorage.getItem('cognitive_game_stars_v1') || '{}');
        return stars[levelIndex] || 0;
    }

    async function saveCognitiveGameProgress(levelIndex, newStars) {
        const newUnlockedLevel = levelIndex + 1;
        const localUnlocked = getUnlockedLevel();
        const localStars = JSON.parse(localStorage.getItem('cognitive_game_stars_v1') || '{}');

        const needsLevelUpdate = newUnlockedLevel > localUnlocked;
        const needsStarUpdate = newStars > (localStars[levelIndex] || 0);

        if (needsLevelUpdate) localStorage.setItem('cognitive_game_level_v1', newUnlockedLevel);
        if (needsStarUpdate) localStars[levelIndex] = newStars;
        
        if (needsLevelUpdate || needsStarUpdate) {
            localStorage.setItem('cognitive_game_stars_v1', JSON.stringify(localStars));
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                const { error } = await supabaseClient.from('juego_memoria').upsert({ user_id: user.id, unlocked_level: getUnlockedLevel(), stars: localStars });
                if (error) console.error('Error guardando progreso del juego:', error);
            }
        }
    }

    async function openCognitiveGameModal() {
        await syncCognitiveGameProgress();
        renderLevelMenu();
    }

    function renderLevelMenu() {
        const unlocked = getUnlockedLevel();
        let buttonsHtml = '<div class="level-grid">';
        MEMORY_LEVELS.forEach((level, index) => {
            const isLocked = index > unlocked;
            const stars = getLevelStars(index);
            let starStr = '';
            if (stars > 0) starStr = '⭐'.repeat(stars);
            
            const statusClass = isLocked ? 'locked' : (stars > 0 ? 'completed' : '');
            const clickAction = isLocked ? '' : `startLevel(${index})`;
            const label = isLocked ? '🔒' : (index + 1);
            
            buttonsHtml += `
            <div class="level-btn ${statusClass}" onclick="${clickAction}" style="flex-direction:column; gap:2px;">
                <span style="font-size:1.2em">${label}</span>
                <span style="font-size:0.6em; color:#FFD700;">${starStr}</span>
            </div>`;
        });
        buttonsHtml += '</div>';

        const content = `
            <div style="text-align: center;">
                <h3 style="color: var(--neon-blue);">Gimnasio Mental</h3>
                <p style="color: var(--text-secondary); font-size: 0.9em;">Entrena tu memoria y enfoque.</p>
                <button class="btn" onclick="showGameInstructions()" style="padding: 5px 15px; font-size: 0.8em; margin-bottom: 10px; background: transparent; border: 1px solid var(--neon-blue);">📜 Ver Instrucciones</button>
                ${buttonsHtml}
            </div>
        `;
        openModal("🧩 Selección de Nivel", content);
    }
    
    function showGameInstructions() {
         const content = `
            <div style="text-align: left; color: var(--text-primary);">
                <h3 style="color: var(--neon-blue); text-align:center;">Instrucciones</h3>
                <ul style="margin-bottom: 20px; font-size: 0.95em; line-height: 1.5;">
                    <li>🃏 <strong>Encuentra los pares:</strong> Voltea las cartas para encontrar las imágenes idénticas.</li>
                    <li>⏳ <strong>Contra Reloj:</strong> Tienes un tiempo límite. ¡Sé rápido!</li>
                    <li>⭐ <strong>Gana Estrellas:</strong>
                        <br>⭐⭐⭐: Completado en < 50% del tiempo.
                        <br>⭐⭐: Completado en < 75% del tiempo.
                        <br>⭐: Completado a tiempo.
                    </li>
                </ul>
                <button class="btn" onclick="renderLevelMenu()" style="width:100%">¡Entendido!</button>
            </div>
        `;
        openModal("📜 Instrucciones", content);
    }

    function startLevel(levelIndex) {
        currentLevelIndex = levelIndex;
        const config = MEMORY_LEVELS[levelIndex];
        const totalPairs = (config.r * config.c) / 2;
        
        // Tiempo base: 4s por par + 5s extra
        totalTime = Math.max(10, totalPairs * 4 + 5); 
        timeLeft = totalTime;
        
        const content = `
            <div style="text-align: center;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; color: var(--text-primary); padding: 0 5px;">
                    <button class="btn" onclick="stopGameAndMenu()" style="margin:0; padding: 5px 10px; font-size: 0.8em; background: transparent; border: 1px solid rgba(255,255,255,0.2);">⬅ Salir</button>
                    <span style="color: var(--neon-blue);">Nivel ${levelIndex + 1}</span>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); height: 6px; width: 100%; border-radius: 3px; margin-bottom: 10px; overflow: hidden;">
                    <div id="timer-bar" style="height: 100%; width: 100%; background: var(--neon-blue); transition: width 1s linear;"></div>
                </div>
                <div style="font-size: 0.8em; margin-bottom: 10px;">Tiempo: <span id="timer-text">${timeLeft}</span>s | Pares: <span id="match-count">0</span>/${totalPairs}</div>

                <div class="memory-game" id="memory-board" style="grid-template-columns: repeat(${config.c}, 1fr);"></div>
            </div>
        `;
        openModal(`🧩 Nivel ${levelIndex + 1}`, content);
        setTimeout(() => initMemoryGame(config), 100);
    }
    
    function stopGameAndMenu() {
        clearInterval(gameTimerInterval);
        renderLevelMenu();
    }

    function initMemoryGame(config) {
        const board = document.getElementById('memory-board');
        if(!board) return;
        
        board.innerHTML = '';
        matchesFound = 0;
        document.getElementById('match-count').innerText = '0';
        hasFlippedCard = false;
        lockBoard = false;
        firstCard = null;
        secondCard = null;

        const totalCards = config.r * config.c;
        const pairsNeeded = totalCards / 2;
        const gameIcons = CARDS_ICONS.slice(0, pairsNeeded);
        const cards = [...gameIcons, ...gameIcons];
        cards.sort(() => 0.5 - Math.random());
        const fontSize = config.c >= 5 ? '1.2em' : '2em';

        cards.forEach(icon => {
            const card = document.createElement('div');
            card.classList.add('memory-card');
            card.dataset.icon = icon;
            
            const front = document.createElement('div');
            front.classList.add('front-face');
            front.innerText = icon;
            front.style.fontSize = fontSize;
            
            const back = document.createElement('div');
            back.classList.add('back-face');
            back.innerText = '?';

            card.appendChild(front);
            card.appendChild(back);
            card.addEventListener('click', flipCard);
            board.appendChild(card);
        });
        
        // Start Timer
        clearInterval(gameTimerInterval);
        updateTimerUI();
        gameTimerInterval = setInterval(() => {
            timeLeft--;
            updateTimerUI();
            if (timeLeft <= 0) {
                clearInterval(gameTimerInterval);
                alert("⏳ ¡Tiempo agotado! Inténtalo de nuevo.");
                startLevel(currentLevelIndex); // Restart
            }
        }, 1000);
    }
    
    function updateTimerUI() {
        const text = document.getElementById('timer-text');
        const bar = document.getElementById('timer-bar');
        if(text) text.innerText = timeLeft;
        if(bar) {
            const pct = (timeLeft / totalTime) * 100;
            bar.style.width = `${pct}%`;
            if(pct < 30) bar.style.background = '#ff5252';
            else bar.style.background = 'var(--neon-blue)';
        }
    }

    async function flipCard() {
        if (lockBoard) return;
        if (this === firstCard) return;
        this.classList.add('flip');
        if (!hasFlippedCard) { hasFlippedCard = true; firstCard = this; return; }
        secondCard = this;
        
        if (firstCard.dataset.icon === secondCard.dataset.icon) {
            firstCard.removeEventListener('click', flipCard); secondCard.removeEventListener('click', flipCard);
            matchesFound++; document.getElementById('match-count').innerText = matchesFound;
            
            const config = MEMORY_LEVELS[currentLevelIndex];
            if(matchesFound === (config.r * config.c) / 2) {
                clearInterval(gameTimerInterval);
                
                // Calculate Stars
                let stars = 1;
                if (timeLeft > totalTime * 0.5) stars = 3;
                else if (timeLeft > totalTime * 0.25) stars = 2;
                
                await saveCognitiveGameProgress(currentLevelIndex, stars);
                
                setTimeout(() => {
                    const starDisplay = '⭐'.repeat(stars);
                    const content = `
                        <div style="text-align:center;">
                            <div style="font-size: 3em; margin-bottom: 10px;">🎉</div>
                            <h2 style="color: var(--neon-blue);">¡Nivel Completado!</h2>
                            <div style="font-size: 2em; margin: 10px 0;">${starDisplay}</div>
                            <p>Tiempo restante: ${timeLeft}s</p>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn" onclick="renderLevelMenu()" style="background:transparent; border:1px solid white;">Menú</button>
                                ${currentLevelIndex + 1 < MEMORY_LEVELS.length ? 
                                `<button class="btn" onclick="startLevel(${currentLevelIndex + 1})">Siguiente ➡</button>` : 
                                `<p>¡Juego Completado!</p>`}
                            </div>
                        </div>
                    `;
                    openModal("¡Victoria!", content);
                }, 500);
            }
            [hasFlippedCard, lockBoard] = [false, false]; [firstCard, secondCard] = [null, null];
        } else {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flip'); secondCard.classList.remove('flip');
                [hasFlippedCard, lockBoard] = [false, false]; [firstCard, secondCard] = [null, null];
            }, 1000);
        }
    }

    // --- NEURO GATE LOGIC (TEST COGNITIVO) ---
    let neuroState = 'idle'; // idle, waiting, stimulus, result
    let neuroRound = 0;
    let neuroMaxRounds = 20;
    let neuroTimer;
    let neuroStartTime;
    let neuroData = { reactionTimes: [], falseAlarms: 0, misses: 0 };
    let neuroCurrentType = ''; // 'go' or 'nogo'
    let neuroRuleInverted = false; // Para el cambio de lógica

    function openNeuroGate() {
        const overlay = document.getElementById('neuro-gate-overlay');
        if (overlay) overlay.classList.remove('hidden');
        document.getElementById('neuro-start-screen').style.display = 'block';
        document.getElementById('neuro-results').style.display = 'none';
        document.getElementById('neuro-stimulus').style.display = 'none';
        document.getElementById('neuro-ui-top').style.opacity = '0';
    }

    function closeNeuroGate() {
        const overlay = document.getElementById('neuro-gate-overlay');
        if (overlay) overlay.classList.add('hidden');
        clearTimeout(neuroTimer);
    }

    function startNeuroGate() {
        document.getElementById('neuro-start-screen').style.display = 'none';
        document.getElementById('neuro-ui-top').style.opacity = '1';
        document.getElementById('neuro-stimulus').style.display = 'block';
        
        neuroRound = 0;
        neuroData = { reactionTimes: [], falseAlarms: 0, misses: 0 };
        neuroRuleInverted = false;
        
        nextNeuroRound();
    }

    function nextNeuroRound() {
        if (neuroRound >= neuroMaxRounds) {
            finishNeuroGate();
            return;
        }

        neuroRound++;
        document.getElementById('neuro-round').innerText = neuroRound;
        
        // CAMBIO DE LÓGICA A LA MITAD
        if (neuroRound === 11) {
            neuroRuleInverted = true;
            alert("⚠️ ¡CAMBIO DE REGLAS! ⚠️\n\nAhora la lógica es INVERSA.\nLo que antes era seguro, ahora es ALERTA.");
        }

        // Definir reglas visuales
        const colorSafe = neuroRuleInverted ? '#ff5252' : '#4b90ff'; // Azul o Rojo
        const colorDanger = neuroRuleInverted ? '#4b90ff' : '#ff5252';
        const textSafe = neuroRuleInverted ? 'ROJO' : 'AZUL';
        
        document.getElementById('neuro-instruction').innerHTML = `Toca si es <span style="color:${colorSafe}">${textSafe}</span>`;
        
        // Ocultar estímulo (Intervalo entre estímulos)
        const stim = document.getElementById('neuro-stimulus');
        stim.style.transform = 'scale(0)';
        stim.style.opacity = '0';
        neuroState = 'waiting';

        // Tiempo aleatorio de espera (1s a 2.5s) para evitar anticipación rítmica
        const waitTime = Math.random() * 1500 + 1000;

        neuroTimer = setTimeout(() => {
            // Determinar si es GO (80% prob) o NO-GO (20% prob)
            // En ansiedad, el reto es NO tocar en el 20% de los casos
            const isGo = Math.random() > 0.25; 
            neuroCurrentType = isGo ? 'go' : 'nogo';
            
            stim.style.backgroundColor = isGo ? colorSafe : colorDanger;
            stim.style.transform = 'scale(1)';
            stim.style.opacity = '1';
            
            neuroStartTime = Date.now();
            neuroState = 'stimulus';

            // Tiempo límite para responder (1s)
            neuroTimer = setTimeout(() => {
                if (neuroState === 'stimulus') {
                    // Se acabó el tiempo
                    if (neuroCurrentType === 'go') {
                        neuroData.misses++; // Era GO y no tocó
                        showNeuroFeedback("LENTO", "#ff9800");
                    } else {
                        // Era NOGO y no tocó -> ¡BIEN! (Inhibición correcta)
                        showNeuroFeedback("BIEN", "#4caf50");
                    }
                    nextNeuroRound();
                }
            }, 1000); // Ventana de respuesta

        }, waitTime);
    }

    function handleNeuroInput(e) {
        if (e) e.preventDefault(); // Evitar doble disparo touch/mouse
        if (neuroState !== 'stimulus') return;

        const reactionTime = Date.now() - neuroStartTime;
        neuroState = 'result';
        clearTimeout(neuroTimer); // Detener el timeout de "miss"

        if (neuroCurrentType === 'go') {
            // Correcto
            neuroData.reactionTimes.push(reactionTime);
            nextNeuroRound();
        } else {
            // Incorrecto (Falsa Alarma / Impulsividad)
            neuroData.falseAlarms++;
            showNeuroFeedback("¡NO!", "#ff5252");
            // Pequeña penalización de tiempo antes de la siguiente ronda
            setTimeout(nextNeuroRound, 500);
        }
    }

    function showNeuroFeedback(text, color) {
        const fb = document.getElementById('neuro-feedback-msg');
        fb.innerText = text;
        fb.style.color = color;
        fb.style.opacity = '1';
        fb.style.transform = 'scale(1.2)';
        setTimeout(() => {
            fb.style.opacity = '0';
            fb.style.transform = 'scale(1)';
        }, 500);
    }

    function finishNeuroGate() {
        document.getElementById('neuro-stimulus').style.display = 'none';
        document.getElementById('neuro-ui-top').style.opacity = '0';
        document.getElementById('neuro-results').style.display = 'block';

        // Calcular métricas
        const avgTime = neuroData.reactionTimes.length > 0 
            ? Math.round(neuroData.reactionTimes.reduce((a,b)=>a+b,0) / neuroData.reactionTimes.length) 
            : 0;
        
        // Lógica de Mejor Puntaje (LocalStorage)
        const BEST_SCORE_KEY = 'neuro_gate_best_score_v1';
        let bestScore = parseInt(localStorage.getItem(BEST_SCORE_KEY)) || 0;
        let isNewRecord = false;

        // Solo guardamos si el tiempo es válido y la impulsividad es aceptable (<= 3 errores)
        if (avgTime > 0 && neuroData.falseAlarms <= 3) {
            if (bestScore === 0 || avgTime < bestScore) {
                bestScore = avgTime;
                localStorage.setItem(BEST_SCORE_KEY, bestScore);
                isNewRecord = true;
            }
        }

        document.getElementById('res-time').innerText = avgTime + "ms";
        document.getElementById('res-best').innerText = (bestScore > 0 ? bestScore + "ms" : "-") + (isNewRecord ? " (NUEVO!)" : "");
        document.getElementById('res-impulse').innerText = neuroData.falseAlarms;
        document.getElementById('res-miss').innerText = neuroData.misses;

        let analysis = "";
        if (neuroData.falseAlarms > 3) {
            analysis = "🧠 <strong>Alta Impulsividad Detectada:</strong> Tu cerebro está acelerando antes de procesar. Esto es común en estados de ansiedad o craving. <br><br>💡 <em>Recomendación:</em> Usa la herramienta de 'Respiración' antes de tomar decisiones hoy.";
        } else if (neuroData.misses > 3 || avgTime > 600) {
            analysis = "🧠 <strong>Fatiga Mental / Bloqueo:</strong> Tu tiempo de reacción es lento. Puede ser 'niebla mental' o depresión leve. <br><br>💡 <em>Recomendación:</em> Intenta el 'Gimnasio Mental' para activar tu corteza prefrontal.";
        } else {
            analysis = "🧠 <strong>Estado Óptimo:</strong> Tienes un buen equilibrio entre velocidad y control. Tu función ejecutiva está trabajando bien para protegerte.";
        }
        document.getElementById('res-analysis').innerHTML = analysis;
    }

    // --- LÓGICA DE INSTALACIÓN PWA ---
    let deferredPrompt;
    const installContainer = document.getElementById('install-container');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevenir que Chrome muestre el prompt automáticamente (opcional, para controlarlo nosotros)
        e.preventDefault();
        deferredPrompt = e;
        // Mostrar el botón de instalación en el panel
        if(installContainer) installContainer.style.display = 'block';
    });

    async function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`Resultado de instalación: ${outcome}`);
        deferredPrompt = null;
        if(installContainer) installContainer.style.display = 'none';
    }

    window.addEventListener('appinstalled', () => {
        console.log('PWA instalada con éxito');
        if(installContainer) installContainer.style.display = 'none';
    });
    
     // --- PWA: REGISTRO DEL SERVICE WORKER (Debe ser la última parte del script) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Nota: La ruta debe ser '/' si el service-worker está en la raíz
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado con éxito:', registration);
                })
                .catch(error => {
                    // Esta es la línea que reporta el error, si sucede.
                    console.log('Fallo en el registro del Service Worker:', error);
  
             }); 
             
             // Recargar automáticamente la página si se detecta una nueva versión del Service Worker
             let refreshing;
             navigator.serviceWorker.addEventListener('controllerchange', () => {
                 if (refreshing) return;
                 window.location.reload();
                 refreshing = true;
             });
        });
    }
                  
    // --- JUEGO DE MEMORIA (EMOJIS) ---
                  
    const MAX_LEVEL = 20;
                  
    const MEMORY_KEY = 'memory_game_progress';
                  
    // ... (existing memory game functions)
                  

                  

                  
    // --- JUEGO DE MEMORIA DE COLORES ---
                  
    const COLOR_MAX_LEVEL = 20;
                  
    const COLOR_MEMORY_KEY = 'color_memory_game_progress';
                  
    const COLORS = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFA1', '#FFC300', '#C70039', '#900C3F', '#581845', '#FFD700', '#00FFFF', '#FF00FF', '#00FF00', '#0000FF', '#FF0000', '#800080', '#008080', '#808000', '#800000', '#008000', '#000080'];
                  

                  
    function getColorMemoryProgress() {
                  
        const progress = localStorage.getItem(COLOR_MEMORY_KEY);
                  
        return progress ? JSON.parse(progress) : { unlocked: 1, scores: {} };
                  
    }
                  

                  
    function saveColorMemoryProgress(progress) {
                  
        localStorage.setItem(COLOR_MEMORY_KEY, JSON.stringify(progress));
                  
    }
                  

                  
    function openColorMemoryGameLevels() {
                  
        const progress = getColorMemoryProgress();
                  
        let levelButtons = '';
                  
        for (let i = 1; i <= COLOR_MAX_LEVEL; i++) {
                  
            const isLocked = i > progress.unlocked;
                  
            const isCompleted = progress.scores[i] !== undefined;
                  
            let classes = 'level-btn';
                  
            if (isLocked) classes += ' locked';
                  
            if (isCompleted) classes += ' completed';
                  
            
                  
            levelButtons += `<div class="${classes}" onclick="${isLocked ? '' : `startColorMemoryLevel(${i})`}">
                  
                                ${isLocked ? '🔒' : i}
                  
                           </div>`;
                  
        }
                  

                  
        const content = `
                  
            <h3 style="color: var(--neon-blue);">Gimnasio Mental: Memoria de Colores</h3>
                  
            <p style="font-size:0.9em; opacity:0.8; margin-bottom: 20px;">Encuentra los pares de colores en el menor número de intentos.</p>
                  
            <div class="level-grid">
                  
                ${levelButtons}
                  
            </div>
                  
            <button class="btn" style="margin-top:20px; background: transparent; border: 1px solid #555;" onclick="openExperienciasModal()">Volver</button>
                  
        `;
                  
        openModal("Niveles de Memoria de Colores", content);
                  
    }
                  

                  
    function startColorMemoryLevel(level) {
                  
        closeGenModal();
                  
        
                  
        const numPairs = level + 1;
                  
        const totalCards = numPairs * 2;
                  
        
                  
        let symbols = COLORS.slice(0, numPairs).concat(COLORS.slice(0, numPairs));
                  
        symbols.sort(() => Math.random() - 0.5);
                  

                  
        let gameBoard = '';
                  
        for (let i = 0; i < totalCards; i++) {
                  
            gameBoard += `
                  
                <div class="memory-card" data-symbol="${symbols[i]}">
                  
                    <div class="front-face" style="background-color: ${symbols[i]};"></div>
                  
                    <div class="back-face">?</div>
                  
                </div>
                  
            `;
                  
        }
                  

                  
        const columns = Math.ceil(Math.sqrt(totalCards));
                  
        const gameStyle = `grid-template-columns: repeat(${columns}, 1fr);`;
                  

                  
        const gameContent = `
                  
            <h3 style="color: var(--neon-blue);">Nivel ${level}</h3>
                  
            <div class="memory-game" style="${gameStyle}">
                  
                ${gameBoard}
                  
            </div>
                  
            <p>Intentos: <span id="memory-attempts">0</span></p>
                  
            <button class="btn" onclick="openColorMemoryGameLevels()">Salir</button>
                  
        `;
                  
        
                  
        openModal(`Memoria de Colores: Nivel ${level}`, gameContent);
                  

                  
        const cards = document.querySelectorAll('.memory-card');
                  
        let flippedCards = [];
                  
        let attempts = 0;
                  
        let matchedPairs = 0;
                  
        const attemptsSpan = document.getElementById('memory-attempts');
                  

                  
        cards.forEach(card => card.addEventListener('click', () => {
                  
            if (flippedCards.length < 2 && !card.classList.contains('flip') && !card.classList.contains('matched')) {
                  
                card.classList.add('flip');
                  
                flippedCards.push(card);
                  

                  
                if (flippedCards.length === 2) {
                  
                    attempts++;
                  
                    attemptsSpan.textContent = attempts;
                  
                    const [card1, card2] = flippedCards;
                  
                    if (card1.dataset.symbol === card2.dataset.symbol) {
                  
                        card1.classList.add('matched');
                  
                        card2.classList.add('matched');
                  
                        matchedPairs++;
                  
                        flippedCards = [];
                  
                        if (matchedPairs === numPairs) {
                  
                            setTimeout(() => handleColorLevelWin(level, attempts), 500);
                  
                        }
                  
                    } else {
                  
                        setTimeout(() => {
                  
                            card1.classList.remove('flip');
                  
                            card2.classList.remove('flip');
                  
                            flippedCards = [];
                  
                        }, 1000);
                  
                    }
                  
                }
                  
            }
                  
        }));
                  
    }
                  

                  
    function handleColorLevelWin(level, attempts) {
                  
        alert(`¡Nivel ${level} completado en ${attempts} intentos!`);
                  
        const progress = getColorMemoryProgress();
                  
        
                  
        if (!progress.scores[level] || attempts < progress.scores[level]) {
                  
            progress.scores[level] = attempts;
                  
        }
                  

                  
        if (level < COLOR_MAX_LEVEL && level + 1 > progress.unlocked) {
                  
            progress.unlocked = level + 1;
                  
        }
                  
        
                  
        saveColorMemoryProgress(progress);
                  
        openColorMemoryGameLevels();
                  
    }

    // --- FUNCIONES FALTANTES AGREGADAS ---
    function closeLoom() {
        const overlay = document.getElementById('loom-overlay');
        if(overlay) {
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
        }
    }

    function openInnerChildOrbModal() {
        const content = `
            <div style="text-align: center;">
                <h3 style="color: var(--neon-purple);">Santuario del Niño Interior</h3>
                <p style="color: var(--text-primary); font-size: 0.9em;">Este orbe representa el estado emocional de tu niño interior.</p>
                
                <div class="orb-container">
                    <div class="orb" id="inner-child-orb"></div>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button class="btn" onclick="document.getElementById('inner-child-orb').className='orb'; document.getElementById('orb-msg').innerText='Se siente seguro y amado...';" style="background: var(--neon-blue);">Calmar / Abrazar</button>
                    <button class="btn" onclick="document.getElementById('inner-child-orb').className='orb alert'; document.getElementById('orb-msg').innerText='Está expresando su dolor. Escúchalo.';" style="background: var(--color-alert);">Validar Dolor</button>
                </div>
                
                <p id="orb-msg" style="margin-top: 20px; font-style: italic; min-height: 20px; color: var(--text-secondary);"></p>
            </div>
        `;
        openModal("🔮 Santuario", content);
    }

    function openBrainDumpModal() {
        const tempEntry = loadTempEntry(BRAIN_DUMP_KEY);
        
        const content = `
            <div style="text-align: center;">
                <h3 style="color: #ff9800;">🤯 Vaciado de Cerebro</h3>
                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 15px;">
                    Escribe rápido, sin pensar, sin corregir. Saca todo el ruido mental aquí.
                </p>
                
                <textarea id="brain-dump-textarea" 
                          placeholder="Estoy pensando en... Me preocupa..."
                          style="width: 100%; height: 200px; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-app); color: var(--text-primary); margin-bottom: 15px; resize: vertical; font-family: inherit;"
                          oninput="saveTempEntry(BRAIN_DUMP_KEY, 'brain-dump-textarea')">${tempEntry}</textarea>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="saveNewEntry(BRAIN_DUMP_KEY, 'brain-dump-textarea', 'Vaciado de Cerebro')" style="background: var(--neon-blue); flex: 1;">💾 Guardar</button>
                    <button class="btn" onclick="burnBrainDump()" style="background: var(--color-alert); flex: 1;">🔥 Quemar (Soltar)</button>
                </div>
                
                <button class="btn" onclick="openInnerChildModal()" style="background: transparent; border: 1px solid rgba(255,255,255,0.2); margin-top: 15px; width: 100%;">🔙 Volver al Niño Interior</button>
            </div>
        `;
        openModal("🤯 Vaciado", content);
    }

    function burnBrainDump() {
        if(confirm("¿Estás seguro? Esto borrará el texto permanentemente para simbolizar que lo sueltas.")) {
            document.getElementById('brain-dump-textarea').value = '';
            localStorage.removeItem(`TEMP_${BRAIN_DUMP_KEY}`);
            alert("🔥 Puf... Se ha ido. Respira profundo.");
        }
    }

    // --- INTEGRACIÓN: CÁPSULA ANSIEDAD ---
    function openAnxietyCapsuleModal() {
        const content = `
            <div style="text-align: left;">
                <h3 style="color: var(--neon-blue); text-align: center;">Autoevaluación</h3>
                <p style="font-size: 0.8em; opacity: 0.7; text-align: center;">No es un diagnóstico médico.</p>
                
                <form id="quiz-form">
                    <div style="margin-bottom: 15px;">
                        <p>1. ¿Sientes nerviosismo o ansiedad frecuente?</p>
                        <select id="q1" style="width:100%; padding:8px; border-radius:5px; background:var(--bg-app); color:white; border:1px solid #555;">
                            <option value="0">Nunca</option><option value="1">A veces</option><option value="2">A menudo</option><option value="3">Siempre</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p>2. ¿No puedes detener la preocupación?</p>
                        <select id="q2" style="width:100%; padding:8px; border-radius:5px; background:var(--bg-app); color:white; border:1px solid #555;">
                            <option value="0">Nunca</option><option value="1">A veces</option><option value="2">A menudo</option><option value="3">Siempre</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <p>3. ¿Necesidad de consumir para relajarte?</p>
                        <select id="q3" style="width:100%; padding:8px; border-radius:5px; background:var(--bg-app); color:white; border:1px solid #555;">
                            <option value="0">Nunca</option><option value="1">A veces</option><option value="2">A menudo</option><option value="3">Siempre</option>
                        </select>
                    </div>
                </form>
                <div id="quiz-result" style="display:none; padding:15px; border-radius:10px; margin-top:15px; font-weight:bold; text-align:center;"></div>
                <button class="btn" onclick="calculateAnxietyScore()" style="width:100%; margin-top:10px;">Ver Resultados</button>
            </div>
        `;
        openModal("💊 Cápsula de Evaluación", content);
    }

    function calculateAnxietyScore() {
        const q1 = parseInt(document.getElementById('q1').value);
        const q2 = parseInt(document.getElementById('q2').value);
        const q3 = parseInt(document.getElementById('q3').value);
        const score = q1 + q2 + q3;
        const resDiv = document.getElementById('quiz-result');
        
        let msg = "", color = "";
        if(score <= 3) { msg = "Nivel bajo. Sigue cuidándote."; color = "#66bb6a"; }
        else if(score <= 6) { msg = "Nivel moderado. Habla con alguien."; color = "#ffb74d"; }
        else { msg = "Nivel alto. Busca apoyo profesional."; color = "#ff5252"; }
        
        resDiv.style.display = 'block';
        resDiv.style.background = color;
        resDiv.style.color = 'black';
        resDiv.innerText = msg;
    }

    // --- INTEGRACIÓN: ANALIZADOR SUSTANCIAS ---
    const sustanciasData = {
        alcohol: { 
            nombre: "Alcohol", clase: "Depresor", riesgo: "Alto", sangre: "Hasta 12 horas",
            peligros: "Daño hepático, accidentes, dependencia.", interacciones: "⚠️ PELIGROSO con benzos/opiáceos.", visual: "effect-blur",
            test: [
                { pregunta: "¿Bebes solo/a con frecuencia?" },
                { pregunta: "¿Has tenido 'lagunas mentales' por beber?" },
                { pregunta: "¿Alguien cercano ha expresado preocupación por tu forma de beber?" }
            ]
        },
        cannabis: { 
            nombre: "Cannabis", clase: "Psicoactivo", riesgo: "Medio", sangre: "Hasta 2-7 días (uso frecuente)",
            peligros: "Ansiedad, paranoia, afectación de memoria.", interacciones: "⚠️ Potencia sedación con otros depresores.", visual: "effect-distort",
            test: [
                { pregunta: "¿Lo usas a diario o casi a diario?" },
                { pregunta: "¿Sientes que lo necesitas para relajarte, comer o dormir?" },
                { pregunta: "¿Has descuidado responsabilidades por consumirlo?" }
            ]
        },
        cocaina: { 
            nombre: "Cocaína", clase: "Estimulante", riesgo: "Muy Alto", sangre: "Hasta 2 días",
            peligros: "Infarto, psicosis, adicción severa.", interacciones: "🚨 MORTAL con alcohol (cocaetileno).", visual: "effect-shake",
            test: [
                { pregunta: "¿Has gastado más dinero del que tenías planeado en ello?" },
                { pregunta: "¿Sientes un fuerte deseo (craving) cuando no lo usas?" },
                { pregunta: "¿Has mezclado su consumo con alcohol u otras sustancias?" }
            ]
        },
        mdma: { 
            nombre: "MDMA", clase: "Empatógeno", riesgo: "Alto", sangre: "Hasta 1-2 días",
            peligros: "Hipertermia, neurotoxicidad, deshidratación.", interacciones: "🚨 RIESGO de síndrome serotoninérgico con antidepresivos (ISRS).", visual: "effect-distort",
            test: [
                { pregunta: "¿Lo consumes en fiestas o eventos sociales principalmente?" },
                { pregunta: "¿Has sentido una 'bajada' emocional intensa días después de consumir?" },
                { pregunta: "¿Verificas la procedencia o pureza de lo que consumes?" }
            ]
        },
        benzo: { 
            nombre: "Benzos", clase: "Depresor", riesgo: "Muy Alto", sangre: "Hasta 1-3 días",
            peligros: "Alta dependencia, amnesia, sobredosis.", interacciones: "🚨 MORTAL con alcohol/opiáceos por depresión respiratoria.", visual: "effect-blur",
            test: [
                { pregunta: "¿Los tomas sin receta médica?" },
                { pregunta: "¿Has aumentado la dosis para sentir el mismo efecto (tolerancia)?" },
                { pregunta: "¿Sientes ansiedad o pánico si no los tienes a mano?" }
            ]
        }
    };

    function openToxicTestModal() {
        const content = `
            <div class="toxic-container">
                <h3 style="color: var(--neon-blue); margin-top:0; text-align:center;">Selecciona una sustancia para analizar</h3>
                <div class="sustancia-selector">
                    <button class="sustancia-btn" onclick="showToxicInfo('alcohol', this)">Alcohol</button>
                    <button class="sustancia-btn" onclick="showToxicInfo('cannabis', this)">Cannabis</button>
                    <button class="sustancia-btn" onclick="showToxicInfo('cocaina', this)">Cocaína</button>
                    <button class="sustancia-btn" onclick="showToxicInfo('mdma', this)">MDMA</button>
                    <button class="sustancia-btn" onclick="showToxicInfo('benzo', this)">Benzos</button>
                </div>
                <div id="toxic-info" class="toxic-panel"></div>
                <div id="simulador-visual">SELECCIONA UNA</div>
            </div>
        `;
        openModal("🧪 Analizador de Riesgos", content);
    }

    function showToxicInfo(key, btnElement) {
        // Marcar botón activo
        document.querySelectorAll('.sustancia-btn').forEach(btn => btn.classList.remove('active'));
        if (btnElement) btnElement.classList.add('active');

        const data = sustanciasData[key];
        const panel = document.getElementById('toxic-info');
        const sim = document.getElementById('simulador-visual');
        
        let riskClass = data.riesgo.toLowerCase().includes('alto') ? 'risk-danger' : (data.riesgo.toLowerCase().includes('medio') ? 'risk-warning' : 'risk-success');
        
        panel.style.display = 'block';
        panel.innerHTML = `
            <h3 style="margin-top:0; color:var(--neon-blue);">${data.nombre}</h3>
            <p><strong>Clase:</strong> ${data.clase}</p>
            <p><strong>Nivel de Riesgo:</strong> ${data.riesgo} <span class="risk-label ${riskClass}"></span></p>
            <p><strong>Peligros Clave:</strong> ${data.peligros}</p>
            <p style="color:var(--color-alert);"><strong>Interacciones Peligrosas:</strong> ${data.interacciones}</p>
        `;
        
        sim.className = '';
        void sim.offsetWidth;
        sim.classList.add(data.visual);
        sim.innerText = data.nombre.toUpperCase();
    }
                  
</script>
                  
<!-- Cloudflare Pages Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "fa334cfa34624993b3af9b4dbd3f84e0"}'></script><!-- Cloudflare Pages Analytics -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCDUxoIS2pNcNhsGkelf1kaiatpCQJPKbQ",
    authDomain: "oddoner-a1f1c.firebaseapp.com",
    projectId: "oddoner-a1f1c",
    storageBucket: "oddoner-a1f1c.firebasestorage.app",
    messagingSenderId: "145944050756",
    appId: "1:145944050756:web:747a3c0a08207da01bd011",
    measurementId: "G-PEFW0X4WR4"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</body>
</html>
